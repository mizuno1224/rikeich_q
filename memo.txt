# 理系チャンネル 問題解説アプリ 管理マニュアル

このマニュアルは、アプリのデータ更新、ソースコード管理、および本番環境への公開手順をまとめたものです。
管理者は**ローカル環境（自分のPC）**でデータを編集し、**Git**で変更履歴を共有し、**Firebase**を通じてWeb上に公開します。

**重要: 複数台のPCで管理する場合、作業開始前に必ず「最新の状態を取得」してください。**

---

## 📑 目次

1. [初回セットアップ](#1-初回セットアップ)
2. [日々の更新フロー](#2-日々の更新フロー)
3. [本番公開（デプロイ）](#3-本番公開デプロイ)
4. [トラブルシューティング](#4-トラブルシューティング)
5. [コマンドチートシート](#5-コマンドチートシート)
6. [関連ドキュメント](#6-関連ドキュメント)

---

## 1. 初回セットアップ

新しいPCで作業を始める場合、最初に1回だけ行う作業です。

### 必要なツールのインストール

| ツール | 用途 | インストール方法 |
| :--- | :--- | :--- |
| **Git** | ソースコード管理 | [git-scm.com](https://git-scm.com/) |
| **Node.js** | Firebaseツール実行環境 | [nodejs.org](https://nodejs.org/) |
| **VS Code** (推奨) | コードエディタ | [code.visualstudio.com](https://code.visualstudio.com/) |
| **Cursor** (推奨) | AI支援エディタ | [cursor.sh](https://cursor.sh/) |

### リポジトリの取得とFirebase設定

ターミナル（PowerShell、コマンドプロンプト、VS Codeのターミナル）で以下を実行します。

```bash
# 1. Firebase CLIツールのインストール（未インストールの場合）
npm install -g firebase-tools

# 2. Firebaseへのログイン（ブラウザが開くのでGoogleアカウントでログイン）
firebase login

# 3. リポジトリのクローン（GitHub等のリモートからソースをダウンロード）
git clone <リポジトリのURL>

# 4. ディレクトリへ移動
cd rikeich_q

# 5. Firebaseプロジェクトの紐付けを確認
firebase use default
```

**確認ポイント:**
- `firebase login` で正しいGoogleアカウントでログインしているか
- `firebase use default` で正しいプロジェクトが選択されているか

---

## 2. 日々の更新フロー

### ⚡ Gitを真とする習慣（最重要ルール）

**基本原則: リモート（GitHub等）の内容が常に正（真）であり、ローカルはそれに合わせる**

この原則により、複数台のPCで作業しても常に最新の状態を保てます。

#### 📋 必須の作業習慣

**1. 作業開始時: 必ずPull（リモートから取得）**
```bash
git pull origin main
```
- 作業を始める前に**必ず**実行
- 他のPCでの変更をローカルに取り込む
- エラーが出た場合は後述の「競合・エラー対応」を参照

**2. 作業終了時: 必ずPush（リモートに送信）**
```bash
# 変更をコミット
git add .
git commit -m "変更内容の説明"

# リモートに送信
git push origin main
```
- 作業が終わったら**必ず**実行
- これをしないと他のPCに変更が反映されない
- Pushできない場合は、先にPullしてから再度Push

#### 🔄 標準的な作業フロー

```
1. git pull origin main  ← 作業開始（リモートから最新を取得）
2. コンテンツ編集
3. git add .
4. git commit -m "変更内容"
5. git push origin main  ← 作業終了（リモートに送信）
```

#### ⚠️ 競合・エラーが発生した場合

**エラー: "Your local changes would be overwritten by merge"**

ローカルの変更がリモートと競合しています。以下の2つの選択肢があります：

**選択肢A: ローカルの変更を破棄してリモートを優先（推奨）**

リモートの内容が正しい場合、ローカルの変更を破棄します。

```bash
# 1. リモートの最新情報を取得
git fetch origin

# 2. ローカルの変更を破棄してリモートの状態にリセット
git reset --hard origin/main
```

**選択肢B: ローカルの変更を保持してマージ**

ローカルの変更も重要で残したい場合。

```bash
# 1. ローカルの変更を一時保存（stash）
git stash

# 2. リモートから最新を取得
git pull origin main

# 3. 保存した変更を適用
git stash pop

# 4. 競合があれば手動で解決後、コミット
git add .
git commit -m "競合を解決"
git push origin main
```

**推奨:** 通常は選択肢A（リモート優先）を推奨します。リモートが常に真であるため、ローカルの変更は破棄してリモートに合わせる方が安全です。

#### 📌 覚えておくべき原則

1. **リモート（GitHub等）が常に正（真）**
2. **作業開始前は必ずPull**
3. **作業終了時は必ずPush**
4. **競合時はリモートを優先（`git reset --hard origin/main`）**

---

### 🔄 標準ワークフロー

```
作業開始 → コンテンツ編集 → 変更保存 → 共有 → 本番公開（必要時）
```

### 手順①：作業開始（最新化）

**⚠️ 重要: 作業開始前に必ず実行してください。**

別のPCでの作業内容を取り込みます。

```bash
git pull origin main
```

**確認事項:**
- エラーが出ないか
- 競合（conflict）が発生していないか

### 手順②：コンテンツの編集・確認

#### 方法A: Cursorでの自動生成（推奨・新規問題追加時）

**画像・PDFから自動で解説ページを生成**

1. **Cursorのチャットに画像やPDFをアップロード**
   - 問題の画像やPDFをCursorのチャットにドラッグ&ドロップ

2. **教材情報を指定**
   ```
   以下の問題について解説ページを作成してください。
   
   【教材情報】
   - 教材タイプ: 共通テスト (exam_common)
   - 年度: 2026
   - 問題番号: 大問1
   - ファイル名ID: 2026_q1
   ```

3. **自動生成の実行**
   - Cursorが自動的に解説HTMLと登録JSONを生成
   - 生成されたコードを確認し、必要に応じて調整

4. **ファイルの保存**
   - 生成されたHTMLとJSONを適切な場所に保存
   - マニフェストが自動更新されます

**詳細:** `CURSOR_WORKFLOW.md` または `QUICKSTART_CURSOR.md` を参照

#### 方法B: Admin画面での編集（既存問題の編集・確認）

ローカルサーバーを立ち上げて、動作確認やAdmin機能を利用します。

```bash
# ローカルサーバーの起動
firebase emulators:start
```

**アクセス方法:**
- メインサイト: `http://localhost:5000`
- 管理画面: `http://localhost:5000/admin.html`

**注意事項:**
- `admin.html` はセキュリティ制限（CORS）のため、ファイルを直接開くだけでは動きません
- Firebaseのエミュレータを使うのが確実です
- 編集後、ブラウザ上の「💾 全体保存」ボタンを押すと**PC内のファイルが書き換わります**

**Admin画面の主な機能:**
- 問題の追加・編集・削除
- 科目・分野の管理
- AI生成コードの取り込み（🤖 AI取込ボタン）
- プレビュー・分析機能

### 手順③：変更の保存（Git Commit）

作業が終わったら、変更内容を保存（コミット）します。

```bash
# 1. 変更されたファイルを確認
git status

# 2. すべての変更をステージング（登録）
git add .

# 3. コミット（変更内容のメッセージを付けて保存）
git commit -m "修正"
```

**コミットメッセージの例:**
- `解説ページ追加: 2026年共通テスト第1問`
- `問題修正: ドップラー効果の解説を更新`
- `新規教材追加: リードα第3章`

### 手順④：共有（Git Push）

コミットした内容をクラウド（GitHub等）にアップロードします。
**これをしないと他のPCに反映されません。**

```bash
git push origin main
```

**確認事項:**
- エラーが出ていないか
- 正常にアップロードされたか

---

## 3. 本番公開（デプロイ）

ローカルでの確認が完了し、GitへのPushも済んだら、Web上の本番環境を更新します。

```bash
# 本番環境へデプロイ
firebase deploy
```

**デプロイ前の確認:**
- ✅ ローカルで動作確認済み
- ✅ GitにPush済み
- ✅ 変更内容を確認済み

**デプロイ後:**
- 成功すると `Deploy complete!` と表示されます
- Hosting URLで公開されたサイトを確認できます

**注意:** デプロイは慎重に行ってください。本番環境に直接影響します。

---

## 4. トラブルシューティング

### Q1. `git push` しようとしたらエラーが出た

**エラーメッセージ:**
```
hint: Updates were rejected because the remote contains work that you do not have locally.
```
または
```
error: Your local changes to the following files would be overwritten by merge:
```

**原因:** 別のPCで先に更新が行われています。リモート（GitHub等）に新しい変更があるため、ローカルの変更と競合しています。

**対応手順（推奨: リモート優先）:**

**原則: リモートが常に真であるため、ローカルの変更を破棄してリモートに合わせる**

```bash
# 1. リモートの最新情報を取得
git fetch origin

# 2. ローカルの変更を破棄してリモートの状態にリセット
git reset --hard origin/main
```

これで、ローカルはリモートと完全に一致します。必要に応じて、リモートの最新状態で作業を再開してください。

**代替方法: ローカルの変更も保持したい場合（上級者向け）**

ローカルの変更も重要で残したい場合のみ、以下の手順を実行します。

```bash
# 1. ローカルの変更を一時保存（stash）
git stash

# 2. リモートから最新を取得
git pull origin main

# 3. 保存した変更を適用
git stash pop

# 4. 競合があれば手動で解決後、コミット
git add .
git commit -m "競合を解決"
git push origin main
```

**注意:** 通常は最初の方法（リモート優先）を推奨します。リモートが常に真であるため、ローカルの変更は破棄してリモートに合わせる方が安全で確実です。

### Q2. 管理画面（admin.html）でファイルが保存できない

**原因:** ブラウザの「File System Access API」の権限許可が切れている可能性があります。

**対応:**
1. ブラウザのアドレスバー付近にある許可設定を確認
2. ローカルファイルへの書き込み権限を再度許可
3. それでも解決しない場合は、ブラウザを再起動

### Q3. Firebaseエミュレータが起動しない

**原因:** ポートが既に使用されている、またはFirebase設定の問題

**対応:**
```bash
# ポートを確認
netstat -ano | findstr :5000

# 必要に応じてポートを変更（firebase.jsonで設定）
firebase emulators:start --port 5001
```

### Q4. 生成されたHTMLが正しく表示されない

**確認事項:**
- ES5互換の記述になっているか（`const` → `var`、アロー関数 → `function`）
- `sample.html` の構造を守っているか
- 必要なクラス名が正しく使用されているか

**対応:**
- `.cursorrules` の技術スタックと記述ルールを確認
- `sample.html` を参考に修正

### Q5. マニフェストが正しく更新されない

**確認事項:**
- JSONの形式が正しいか
- `explanationPath` が正しいか
- 教材IDが `manifest.json` に存在するか

**対応:**
- JSONの構文エラーを確認
- `data/manifest.json` で教材IDを確認
- 必要に応じて手動で `data/materials/{教材ID}.json` を編集

---

## 5. コマンドチートシート

### 日常的な作業フロー

| 作業 | コマンド | 実行タイミング |
| :--- | :--- | :--- |
| **作業開始** | `git pull origin main` | **毎回最初**に実行 |
| **ローカル確認** | `firebase emulators:start` | 編集・動作確認時 |
| **変更確認** | `git status` | コミット前 |
| **変更確定** | `git add .`<br>`git commit -m "メッセージ"` | 作業区切りごと |
| **共有** | `git push origin main` | 作業終了時 |
| **本番公開** | `firebase deploy` | Web公開したい時 |

### よく使うGitコマンド

```bash
# 変更状況の確認
git status

# 変更内容の確認
git diff

# コミット履歴の確認
git log --oneline

# 特定のファイルのみステージング
git add data/explanations/textbook_basic/01/01/test.html

# 直前のコミットメッセージを変更
git commit --amend -m "新しいメッセージ"

# 【重要】リモート優先: ローカルの変更を破棄してリモートに合わせる
git fetch origin
git reset --hard origin/main
```

### Firebaseコマンド

```bash
# エミュレータの起動
firebase emulators:start

# 特定の機能のみデプロイ
firebase deploy --only hosting

# デプロイ前のプレビュー
firebase hosting:channel:deploy preview
```

---

## 6. 関連ドキュメント

### 主要ドキュメント

| ファイル | 内容 |
| :--- | :--- |
| `CURSOR_WORKFLOW.md` | Cursorでの作業手順書（詳細版） |
| `QUICKSTART_CURSOR.md` | Cursorでのクイックスタートガイド |
| `.cursorrules` | Cursorの自動処理ルール定義 |
| `プロンプト.txt` | 解説ページ生成の詳細ルール（参考） |

### 設定ファイル

| ファイル | 内容 |
| :--- | :--- |
| `data/manifest.json` | 教材一覧 |
| `data/materials/*.json` | 各教材の問題リスト |
| `firebase.json` | Firebase設定 |
| `sample.html` | HTML構造のテンプレート |

### スクリプト

| ファイル | 内容 |
| :--- | :--- |
| `scripts/add-explanation.js` | 自動追加スクリプト（オプション） |

---

## 📝 補足情報

### ファイル構造の理解

```
rikeich_q/
├── data/
│   ├── manifest.json          # 教材一覧
│   ├── materials/             # 各教材の問題リスト
│   │   ├── textbook_basic.json
│   │   ├── exam_common.json
│   │   └── ...
│   └── explanations/           # 解説HTMLファイル
│       ├── textbook_basic/
│       ├── exam_common/
│       └── ...
├── admin.html                 # 管理画面
├── index.html                 # メインサイト
└── ...
```

### 教材タイプ一覧

| 教材タイプ | ID | 説明 |
| :--- | :--- | :--- |
| 物理基礎 | `textbook_basic` | 物理基礎の教科書 |
| 物理 | `textbook_physics` | 物理の教科書 |
| リードα | `lead_alpha` | リードα問題集 |
| リードLight | `lead_light` | リードLight問題集 |
| 共通テスト | `exam_common` | 大学入学共通テスト |
| 国公立入試 | `exam_national` | 国公立大学入試 |
| 私立入試 | `exam_private` | 私立大学入試 |
| その他 | `other` | その他の教材 |

---

**最終更新:** 2024年
**バージョン:** 2.0
