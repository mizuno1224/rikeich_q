<!doctype html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Physics Lab. Manager</title>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/admin.css" />
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css" />

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
  <script type="text/javascript" charset="UTF-8"
    src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>

  <script>
    window.MathJax = {
      tex: {
        inlineMath: [
          ["$", "$"],
          ["\\(", "\\)"],
        ],
        macros: {
          strong: ["\\textcolor{\\#3b82f6}{\\boldsymbol{#1}}", 1],
        },
      },
      svg: { fontCache: "global" },
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>
  <div class="admin-container">
    <header class="admin-header">
      <div class="header-left">
        <h1>Physics Lab. Manager</h1>
      </div>
      <div class="header-actions">
        <button id="btn-open" class="btn-open">📂 プロジェクトを開く</button>

        <button id="btn-open-cloud" class="btn-open" style="border-color:#8b5cf6; color:#7c3aed; background:#f5f3ff;">
          ☁️ クラウド読込
        </button>

        <button id="btn-import-ai" class="btn-open" style="
              border-color: #10b981;
              color: #065f46;
              background: #ecfdf5;
              display: none;
            ">
          🤖 AI取込
        </button>

        <button id="btn-save" class="btn-save" disabled>💾 全体保存</button>
        <a href="index.html" target="_blank" class="btn-preview">サイトを表示</a>
      </div>
    </header>

    <div id="main-ui" class="main-layout" style="display: none">
      <div class="tabs-area" id="material-tabs"></div>

      <div class="content-split">
        <div class="sidebar-area">
          <div class="sidebar-header">
            <h3>構成ツリー</h3>
            <div class="sidebar-tools">
              <button id="btn-add-subject" class="btn-tool" title="科目を追加">
                ＋科目
              </button>
            </div>
          </div>
          <div id="tree-root"></div>
        </div>

        <div class="editor-area" id="editor-panel">
          <div class="empty-state">
            <p>👈 左のツリーから編集したい問題を選択してください</p>
          </div>

          <div id="editor-main-wrapper" style="display: none; height: 100%; flex-direction: column">
            <div class="editor-header">
              <div style="flex: 1">
                <h2 id="editing-title" style="margin: 0">問題タイトル</h2>
                <span id="editing-id" class="badge-id">ID: ...</span>
              </div>

              <div class="view-switch">
                <button id="tab-edit" class="view-tab active">📝 編集</button>
                <button id="tab-preview" class="view-tab">
                  👁️ プレビュー
                </button>
                <button id="tab-analyze" class="view-tab">📊 分析</button>
              </div>
            </div>

            <div id="view-editor" class="view-content active">
              <div id="form-container"></div>
            </div>

            <div id="view-preview" class="view-content" style="padding: 0; background: #fff; overflow: hidden">
              <div id="preview-container" class="viewer-split-content" style="width: 100%; height: 100%; padding: 0">
              </div>
            </div>

            <div id="view-analyze" class="view-content" style="padding: 20px; background: #f8fafc">
              <div id="analyze-container">
                <p>データを読み込んでいます...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="initial-msg" class="placeholder-text" style="margin-top: 100px">
      上の「📂 プロジェクトを開く」ボタンから、プロジェクトのルートフォルダを選択してください。<br>
      または「☁️ クラウド読込」で集計結果のみを確認できます。
    </div>
  </div>

  <div id="code-modal" class="modal-overlay" style="display: none">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">JS編集</h2>
        <button id="btn-close-modal" class="btn-mini">✕ 閉じる</button>
      </div>
      <div class="modal-body">
        <textarea id="code-editor" spellcheck="false"></textarea>
      </div>
      <div class="modal-footer">
        <button id="btn-save-code" class="btn-save">コードを保存</button>
      </div>
    </div>
  </div>

  <div id="import-modal" class="modal-overlay" style="display: none">
    <div class="modal-content" style="max-width: 1000px; height: 90%">
      <div class="modal-header" style="background: #ecfdf5">
        <h2 style="color: #065f46">🤖 AI生成コード新規追加</h2>
        <button id="btn-close-import" class="btn-mini">✕ 閉じる</button>
      </div>

      <div class="modal-body" style="
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
          ">
        <div style="padding: 15px; background: #f1f5f9; border-radius: 8px">
          <label style="font-weight: bold; display: block; margin-bottom: 5px">1. 追加先の教材を選択</label>
          <select id="import-target-material" style="
                padding: 8px;
                width: 100%;
                max-width: 400px;
                border-radius: 4px;
                border: 1px solid #ccc;
              ">
            <option value="">(プロジェクトを開いてください)</option>
          </select>
        </div>

        <div class="split-3-columns" style="display: flex; gap: 15px; flex: 1; min-height: 0">
          <div style="flex: 1; display: flex; flex-direction: column">
            <label class="label-import">【ブロック1】解説HTML</label>
            <textarea id="imp-html" class="textarea-import" placeholder="<h2...>..."></textarea>
          </div>
          <div style="flex: 1; display: flex; flex-direction: column">
            <label class="label-import">【ブロック2】登録JSON</label>
            <textarea id="imp-json" class="textarea-import" placeholder="{ 'id': '...', ... }"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-exec-import" class="btn-save" style="background: #10b981">
          🚀 ファイル生成して追加
        </button>
      </div>
    </div>
  </div>

  <div id="toast-container" class="toast-container"></div>

  <script src="js/sim-utils.js"></script>
  <script src="js/admin-core.js"></script>
  <script src="js/admin-fs.js"></script>
  <script src="js/admin-ui.js"></script>
  <script src="js/admin-actions.js"></script>

  <script>
    // ▼▼▼ Firebaseコンソールからコピーした内容をここに貼る ▼▼▼
    const firebaseConfig = {
      apiKey: "AIzaSyBObf6A_NDje3mpW1qxsfrNGnikdeDQOsA",
      authDomain: "rikeich-q.firebaseapp.com",
      projectId: "rikeich-q",
      storageBucket: "rikeich-q.firebasestorage.app",
      messagingSenderId: "779478068459",
      appId: "1:779478068459:web:6f223b0116b2b2b08122ae"
    };
    // ▲▲▲▲▲▲

    if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.firestore();
      console.log("Firebase initialized!");
    } else {
      console.warn("Firebase設定が完了していません。admin.htmlのソースコードを編集してAPIキーを設定してください。");
    }
  </script>
</body>

</html>