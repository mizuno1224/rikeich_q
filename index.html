<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Physics Lab.</title>
    <link rel="stylesheet" href="css/base.css" />
    <style>
      /* 基本スタイル */
      body {
        padding: 20px;
        background: var(--col-bg);
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* ヘッダー */
      h1 {
        text-align: center;
        font-size: 2.2rem;
        margin-bottom: 40px;
        color: var(--col-text);
        letter-spacing: 0.1em;
      }

      /* タブエリア */
      .material-tabs {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 40px;
        flex-wrap: wrap;
      }
      .tab-btn {
        padding: 12px 24px;
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--col-text-sub);
        background: #fff;
        border: 2px solid #e2e8f0;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 140px;
      }
      .tab-btn:hover {
        border-color: var(--col-primary-light);
        background: #f8fafc;
      }
      .tab-btn.active {
        background: var(--col-primary);
        color: #fff;
        border-color: var(--col-primary);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      /* コンテンツエリア */
      .group-section {
        margin-bottom: 60px;
      }
      .group-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #475569;
        margin-bottom: 20px;
        padding-left: 15px;
        border-left: 6px solid #cbd5e1;
      }

      .subject-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
        animation: fadeIn 0.4s ease;
      }
      .subject-card {
        background: #fff;
        border-radius: 24px;
        padding: 30px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        border: 1px solid #f1f5f9;
      }
      .subject-name {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--col-primary);
        margin: 0 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #f1f5f9;
      }

      /* Part (編) Grouping */
      .part-group {
        margin-bottom: 25px;
      }
      .part-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #475569;
        margin-bottom: 10px;
        padding: 6px 10px;
        background: #f1f5f9;
        border-radius: 8px;
      }

      .field-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .field-item {
        margin-bottom: 15px;
        padding-left: 10px;
      }
      .field-name {
        font-weight: 700;
        color: var(--col-text);
        margin-bottom: 8px;
        display: block;
        font-size: 1rem;
        border-left: 4px solid #f43f5e;
        padding-left: 8px;
      }

      .prob-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .prob-link {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        background: #f8fafc;
        border-radius: 10px;
        color: var(--col-text);
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
        font-size: 0.95rem;
      }
      .prob-link:hover {
        background: #fff;
        color: var(--col-primary);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      .prob-empty {
        color: #94a3b8;
        font-size: 0.85rem;
        padding: 6px 10px;
        font-style: italic;
      }

      .empty-msg {
        text-align: center;
        color: #94a3b8;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Physics Lab.</h1>
      <div class="material-tabs" id="tab-container"></div>
      <div
        class="material-tabs"
        id="sub-tab-container"
        style="
          display: none;
          margin-top: -20px;
          margin-bottom: 30px;
          transform: scale(0.95);
        "
      ></div>
      <div id="content-area"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const tabContainer = document.getElementById("tab-container");
        // サブタブ用のコンテナを追加
        let subTabContainer = document.getElementById("sub-tab-container");
        if (!subTabContainer) {
          subTabContainer = document.createElement("div");
          subTabContainer.id = "sub-tab-container";
          subTabContainer.className = "material-tabs";
          subTabContainer.style.cssText =
            "display:none; margin-top:-20px; margin-bottom:30px; transform: scale(0.95);";
          tabContainer.after(subTabContainer);
        }
        const contentArea = document.getElementById("content-area");

        let manifest = [];
        // 入試カテゴリの定義
        const EXAM_TYPES = ["exam_year", "exam_univ"];

        fetch("data/manifest.json")
          .then((res) => res.json())
          .then((data) => {
            manifest = data;
            initTabs();
            if (manifest.length > 0) loadMaterial(0);
          })
          .catch((err) => console.error(err));

        function initTabs() {
          tabContainer.innerHTML = "";
          subTabContainer.innerHTML = "";

          // 1. 通常教材のタブ生成
          manifest.forEach((mat, index) => {
            if (EXAM_TYPES.includes(mat.type)) return; // 入試系はスキップ
            createMainTab(mat.name, index);
          });

          // 2. 入試過去問タブの生成（入試系がある場合のみ）
          const hasExam = manifest.some((m) => EXAM_TYPES.includes(m.type));
          if (hasExam) {
            const btn = document.createElement("button");
            btn.className = "tab-btn";
            btn.textContent = "入試過去問";
            btn.dataset.isExam = "true";
            btn.onclick = () => showExamTabs(btn);
            tabContainer.appendChild(btn);
          }
        }

        function createMainTab(name, index) {
          const btn = document.createElement("button");
          btn.className = "tab-btn";
          btn.textContent = name;
          btn.onclick = () => {
            resetTabs();
            btn.classList.add("active");
            subTabContainer.style.display = "none"; // サブタブ隠す
            loadMaterial(index);
          };
          tabContainer.appendChild(btn);
        }

        function showExamTabs(parentBtn) {
          resetTabs();
          parentBtn.classList.add("active");

          // サブタブの生成
          subTabContainer.innerHTML = "";
          subTabContainer.style.display = "flex";

          let firstExamIndex = -1;

          manifest.forEach((mat, index) => {
            if (!EXAM_TYPES.includes(mat.type)) return;
            if (firstExamIndex === -1) firstExamIndex = index;

            const subBtn = document.createElement("button");
            subBtn.className = "tab-btn";
            subBtn.style.fontSize = "0.95rem"; // 少し小さく
            subBtn.textContent = mat.name;
            subBtn.onclick = () => {
              // サブタブのアクティブ切り替え
              Array.from(subTabContainer.children).forEach((b) =>
                b.classList.remove("active"),
              );
              subBtn.classList.add("active");
              loadMaterial(index);
            };
            subTabContainer.appendChild(subBtn);
          });

          // 最初の入試教材を自動ロード
          if (firstExamIndex !== -1 && subTabContainer.firstChild) {
            subTabContainer.firstChild.click();
          }
        }

        function resetTabs() {
          const tabs = document.querySelectorAll(".tab-btn");
          tabs.forEach((t) => t.classList.remove("active"));
        }

        // loadMaterial, renderContent は既存のまま
        function loadMaterial(index) {
          // (既存のコードと同じ)
          const item = manifest[index];
          const jsonPath = item.path;
          contentArea.innerHTML =
            '<div style="text-align:center; padding:40px; color:#666;">読み込み中...</div>';

          fetch(jsonPath)
            .then((res) => res.json())
            .then((materialData) => renderContent(materialData))
            .catch((err) => {
              console.error(err);
              contentArea.innerHTML = `<p style="text-align:center; color:red;">読み込み失敗</p>`;
            });
        }

        function renderContent(material) {
          let html = `<div class="subject-grid">`;
          if (material.subjects) {
            material.subjects.forEach((subject) => {
              // 科目(Subject)ごとにカードを作成
              // Subject内に問題があるかチェック
              const hasProblems =
                subject.fields &&
                subject.fields.some((f) => f.problems && f.problems.length > 0);

              if (hasProblems) {
                html += `<div class="subject-card">`;
                // Subject名を表示 (例: "2025年度" や "東京大学")
                html += `<h3 class="subject-name">${subject.subjectName}</h3>`;
                html += `<ul class="field-list">`;

                subject.fields.forEach((field) => {
                  if (field.problems && field.problems.length > 0) {
                    html += `<li class="field-item">`;
                    // Field名を表示 (例: "本試験" や "2024年度")
                    html += `<span class="field-name">${field.fieldName}</span>`;
                    html += `<div class="prob-grid">`;
                    field.problems.forEach((p) => {
                      const targetUrl = `viewer.html?path=${encodeURIComponent(p.explanationPath)}`;
                      html += `<a href="${targetUrl}" class="prob-link" target="_blank"><span>${p.title}</span></a>`;
                    });
                    html += `</div></li>`;
                  }
                });
                html += `</ul></div>`;
              }
            });
          }
          html += `</div>`;
          contentArea.innerHTML = html;
        }
      });
    </script>
  </body>
</html>