<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Physics Lab.</title>
  <link rel="stylesheet" href="css/base.css">
  <style>
    /* 基本スタイル */
    body { padding: 20px; background: var(--col-bg); min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; }
    
    /* ヘッダー */
    h1 { 
      text-align: center; font-size: 2.2rem; margin-bottom: 40px; 
      color: var(--col-text); letter-spacing: 0.1em; 
    }

    /* タブエリア */
    .material-tabs { 
      display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; 
    }
    .tab-btn { 
      padding: 12px 24px; font-weight: 700; font-size: 1.1rem; 
      color: var(--col-text-sub); background: #fff; border: 2px solid #e2e8f0; 
      border-radius: 50px; cursor: pointer; transition: all 0.2s; min-width: 140px; 
    }
    .tab-btn:hover { 
      border-color: var(--col-primary-light); background: #f8fafc; 
    }
    .tab-btn.active { 
      background: var(--col-primary); color: #fff; 
      border-color: var(--col-primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); 
    }

    /* コンテンツエリア */
    .group-section { margin-bottom: 60px; }
    .group-title {
      font-size: 1.5rem; font-weight: bold; color: #475569;
      margin-bottom: 20px; padding-left: 15px; border-left: 6px solid #cbd5e1;
    }

    .subject-grid { 
      display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
      gap: 30px; animation: fadeIn 0.4s ease; 
    }
    .subject-card { 
      background: #fff; border-radius: 24px; padding: 30px; 
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
    }
    .subject-name { 
      font-size: 1.4rem; font-weight: 700; color: var(--col-primary); 
      margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; 
    }

    /* Part (編) Grouping */
    .part-group { margin-bottom: 25px; }
    .part-title {
      font-size: 1.1rem; font-weight: bold; color: #475569;
      margin-bottom: 10px; padding: 6px 10px; background: #f1f5f9; border-radius: 8px;
    }

    .field-list { list-style: none; padding: 0; margin: 0; }
    .field-item { margin-bottom: 15px; padding-left: 10px; }
    .field-name { 
      font-weight: 700; color: var(--col-text); margin-bottom: 8px; 
      display: block; font-size: 1rem; border-left: 4px solid #f43f5e; padding-left: 8px; 
    }

    .prob-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .prob-link { 
      display: flex; justify-content: space-between; align-items: center; 
      padding: 10px 14px; background: #f8fafc; border-radius: 10px; 
      color: var(--col-text); font-weight: 500; text-decoration: none; transition: all 0.2s; font-size: 0.95rem;
    }
    .prob-link:hover { 
      background: #fff; color: var(--col-primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
    }
    .prob-empty {
        color: #94a3b8; font-size: 0.85rem; padding: 6px 10px; font-style: italic;
    }

    .empty-msg { text-align: center; color: #94a3b8; padding: 20px; background: #f8fafc; border-radius: 12px; }

    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Physics Lab.</h1>
    <div class="material-tabs" id="tab-container"></div>
    <div id="content-area"></div>
  </div>

  <script src="js/data.js"></script>
  <script>
    const TAB_CONFIG = [
      { label: "教科書",     ids: ["textbook"] },
      { label: "リードα",   ids: ["lead_alpha"] },
      { label: "リードLight", ids: ["lead_light"] },
      { label: "入試問題",   ids: ["exam_common", "exam_national", "exam_private"] }
    ];

    document.addEventListener('DOMContentLoaded', async () => {
      const tabContainer = document.getElementById('tab-container');
      const contentArea = document.getElementById('content-area');
      
      let manifest = [];
      
      try {
        const res = await fetch('data/manifest.json');
        if (!res.ok) throw new Error('Manifest not found');
        manifest = await res.json();
      } catch (e) {
        try {
          const res = await fetch('problems.json');
          if(res.ok) {
            const legacy = await res.json();
            manifest = legacy.map(m => ({ 
              id: "legacy", name: m.materialName, path: 'problems.json', _legacyData: m 
            }));
            TAB_CONFIG.length = 0;
            manifest.forEach((m, i) => TAB_CONFIG.push({ label: m.name, ids: ["legacy"], _legacyIndex: i }));
          }
        } catch(e2) {
          contentArea.innerHTML = '<p class="empty-msg">データが見つかりません。</p>';
          return;
        }
      }

      TAB_CONFIG.forEach((config, idx) => {
        const btn = document.createElement('button');
        btn.className = `tab-btn ${idx === 0 ? 'active' : ''}`;
        btn.textContent = config.label;
        btn.onclick = () => renderTab(idx);
        tabContainer.appendChild(btn);
      });

      renderTab(0);

      async function renderTab(tabIndex) {
        Array.from(tabContainer.children).forEach((b, i) => {
          b.classList.toggle('active', i === tabIndex);
        });
        
        contentArea.innerHTML = '<p style="text-align:center;color:#666;">読み込み中...</p>';

        const config = TAB_CONFIG[tabIndex];
        const htmlParts = [];

        for (const targetId of config.ids) {
          const item = manifest.find(m => m.id === targetId);
          if (!item && targetId !== "legacy") continue;

          let data = null;
          if (config._legacyIndex !== undefined) {
             data = manifest[config._legacyIndex]._legacyData; 
          } else if (item) {
             try {
               const res = await fetch(item.path);
               if (res.status === 404) {
                 htmlParts.push(renderSection(item.name, null, true));
                 continue; 
               }
               if (!res.ok) throw new Error("Load failed");
               data = await res.json();
             } catch(e) {
               htmlParts.push(renderSection(item.name, null, true));
               continue;
             }
          }

          if (data) {
             htmlParts.push(renderSection(item ? item.name : config.label, data, false, item ? item.path : 'problems.json'));
          }
        }

        contentArea.innerHTML = htmlParts.join('') || '<p class="empty-msg">表示するデータがありません。</p>';
      }

      function renderSection(title, data, isEmpty, jsonPath) {
        if (isEmpty) {
          return `<div class="group-section"><h2 class="group-title">${title}</h2><p class="empty-msg">データ準備中</p></div>`;
        }

        let html = `<div class="group-section">`;
        html += `<h2 class="group-title">${title}</h2>`;
        html += `<div class="subject-grid">`;

        if (!data.subjects || data.subjects.length === 0) {
           html += `<div class="subject-card"><p>問題が登録されていません</p></div>`;
        } else {
          data.subjects.forEach(sub => {
            html += `<div class="subject-card">`;
            html += `<h3 class="subject-name">${sub.subjectName}</h3>`;
            
            // ★変更: 編(Part)ごとにグループ化するロジック
            // fieldNameが "第1編 ... / 第1章 ..." の形式なら分割する
            let currentPart = null;
            let partFields = [];

            // 1. まずデータを構造化
            const structure = [];
            sub.fields.forEach(fld => {
              const parts = fld.fieldName.split(' / ');
              if (parts.length > 1) {
                // "編 / 章" の形式
                const partName = parts[0];
                const chapName = parts[1];
                
                // 新しい編が始まったら
                if (partName !== currentPart) {
                  currentPart = partName;
                  structure.push({ type: 'part', title: partName, chapters: [] });
                }
                // 現在の編に章を追加
                structure[structure.length - 1].chapters.push({ ...fld, displayName: chapName });
              } else {
                // "章" のみ（編がない、またはその他）
                if (currentPart !== null) {
                   currentPart = null; // 編ブロック終了
                }
                structure.push({ type: 'single', ...fld, displayName: fld.fieldName });
              }
            });

            // 2. HTML生成
            structure.forEach(group => {
              if (group.type === 'part') {
                html += `<div class="part-group">`;
                html += `<div class="part-title">${group.title}</div>`;
                html += `<ul class="field-list">`;
                group.chapters.forEach(chap => {
                  html += renderFieldItem(chap, chap.displayName, jsonPath);
                });
                html += `</ul></div>`;
              } else {
                html += `<ul class="field-list">`;
                html += renderFieldItem(group, group.displayName, jsonPath);
                html += `</ul>`;
              }
            });

            html += `</div>`;
          });
        }
        html += `</div></div>`;
        return html;
      }

      function renderFieldItem(fld, name, jsonPath) {
        let h = `<li class="field-item">`;
        h += `<span class="field-name">${name}</span>`;
        h += `<div class="prob-grid">`;
        
        if (fld.problems.length === 0) {
            h += `<div class="prob-empty">(準備中)</div>`;
        } else {
            fld.problems.forEach(p => {
              const srcParam = jsonPath === 'problems.json' ? '' : `&src=${encodeURIComponent(jsonPath)}`;
              h += `<a href="viewer.html?id=${p.id}${srcParam}" class="prob-link">`;
              h += `<span>${p.title}</span>`;
              h += `<span style="font-size:0.9em;color:#cbd5e1;">→</span>`;
              h += `</a>`;
            });
        }
        h += `</div></li>`;
        return h;
      }
    });
  </script>
</body>
</html>