# AIéŸ³å£°ã«ã‚ˆã‚‹è§£èª¬å‹•ç”»ä½œæˆã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€è§£èª¬ã‚¢ãƒ—ãƒªã«AIéŸ³å£°ã«ã‚ˆã‚‹è§£èª¬å‹•ç”»æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [å®Ÿè£…æ–¹æ³•ã®æ¯”è¼ƒ](#å®Ÿè£…æ–¹æ³•ã®æ¯”è¼ƒ)
3. [æ¨å¥¨å®Ÿè£…æ–¹æ³•](#æ¨å¥¨å®Ÿè£…æ–¹æ³•)
4. [è©³ç´°å®Ÿè£…æ‰‹é †](#è©³ç´°å®Ÿè£…æ‰‹é †)
5. [ä½¿ç”¨å¯èƒ½ãªTTSã‚µãƒ¼ãƒ“ã‚¹](#ä½¿ç”¨å¯èƒ½ãªttsã‚µãƒ¼ãƒ“ã‚¹)
6. [å‹•ç”»ç”Ÿæˆã®å®Ÿè£…](#å‹•ç”»ç”Ÿæˆã®å®Ÿè£…)
7. [çµ±åˆæ–¹æ³•](#çµ±åˆæ–¹æ³•)

---

## æ¦‚è¦

### å®Ÿç¾å¯èƒ½ãªæ©Ÿèƒ½

âœ… **AIéŸ³å£°ã«ã‚ˆã‚‹è§£èª¬å‹•ç”»ã®è‡ªå‹•ç”Ÿæˆ**
- è§£èª¬HTMLã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰éŸ³å£°ã‚’ç”Ÿæˆ
- ç”»é¢æ“ä½œï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰ã¨éŸ³å£°ã‚’åŒæœŸ
- å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ãƒ»å†ç”Ÿ

âœ… **ä¸»ãªç”¨é€”**
- ç”Ÿå¾’ãŒé€šå­¦ä¸­ã«èã‘ã‚‹éŸ³å£°è§£èª¬
- è¦–è¦šçš„ãªå‹•ç”»è§£èª¬ã®æä¾›
- ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Š

### æŠ€è¡“çš„ãªå®Ÿç¾å¯èƒ½æ€§

**âœ… å®Œå…¨ã«å®Ÿç¾å¯èƒ½ã§ã™**

ç¾åœ¨ã®æŠ€è¡“ã§ä»¥ä¸‹ã®æ–¹æ³•ãŒåˆ©ç”¨å¯èƒ½ï¼š
1. **ãƒ–ãƒ©ã‚¦ã‚¶ãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…**ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼‰
2. **ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å®Ÿè£…**ï¼ˆFirebase Functionsç­‰ï¼‰
3. **ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å®Ÿè£…**ï¼ˆæ¨å¥¨ï¼‰

---

## å®Ÿè£…æ–¹æ³•ã®æ¯”è¼ƒ

### æ–¹æ³•1: ãƒ–ãƒ©ã‚¦ã‚¶ãƒ™ãƒ¼ã‚¹ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚µãƒ¼ãƒãƒ¼ã‚³ã‚¹ãƒˆãŒä¸è¦
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”ŸæˆãŒå¯èƒ½
- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå¤–éƒ¨ã«é€ä¿¡ã•ã‚Œãªã„ï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶ç´„ãŒã‚ã‚‹
- å“è³ªãŒé™å®šçš„
- å‡¦ç†ãŒé‡ã„

**ä½¿ç”¨æŠ€è¡“:**
- Web Speech APIï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ï¼‰
- MediaRecorder APIï¼ˆç”»é¢éŒ²ç”»ï¼‰
- Canvas APIï¼ˆå‹•ç”»ç”Ÿæˆï¼‰

### æ–¹æ³•2: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼ˆFirebase Functionsï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- é«˜å“è³ªãªéŸ³å£°ç”Ÿæˆ
- è¤‡æ•°ã®TTSã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠå¯èƒ½
- ãƒãƒƒãƒå‡¦ç†ãŒå¯èƒ½

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚µãƒ¼ãƒãƒ¼ã‚³ã‚¹ãƒˆãŒç™ºç”Ÿ
- ç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚‹
- å®Ÿè£…ãŒè¤‡é›‘

**ä½¿ç”¨æŠ€è¡“:**
- Google Cloud Text-to-Speech
- Azure Text-to-Speech
- OpenAI TTS API
- FFmpegï¼ˆå‹•ç”»ç”Ÿæˆï¼‰

### æ–¹æ³•3: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼ˆæ¨å¥¨ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ä¸¡æ–¹ã®ãƒ¡ãƒªãƒƒãƒˆã‚’æ´»ç”¨
- æŸ”è»Ÿãªå®Ÿè£…ãŒå¯èƒ½
- æ®µéšçš„ãªå®Ÿè£…ãŒå¯èƒ½

**å®Ÿè£…æ–¹é‡:**
- éŸ³å£°ç”Ÿæˆï¼šã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼ˆé«˜å“è³ªï¼‰
- å‹•ç”»ç”Ÿæˆï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰

---

## æ¨å¥¨å®Ÿè£…æ–¹æ³•

### ãƒ•ã‚§ãƒ¼ã‚º1: ã‚·ãƒ³ãƒ—ãƒ«ãªéŸ³å£°å†ç”Ÿæ©Ÿèƒ½

ã¾ãšã¯éŸ³å£°ã®ã¿ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€ãã®å¾Œå‹•ç”»æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚

**å®Ÿè£…å†…å®¹:**
1. è§£èª¬ãƒ†ã‚­ã‚¹ãƒˆã®æŠ½å‡º
2. TTS APIã§éŸ³å£°ç”Ÿæˆ
3. éŸ³å£°ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã®è¿½åŠ 
4. å†ç”Ÿã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®åŒæœŸ

### ãƒ•ã‚§ãƒ¼ã‚º2: å‹•ç”»ç”Ÿæˆæ©Ÿèƒ½

éŸ³å£°æ©Ÿèƒ½ãŒå‹•ä½œã—ãŸã‚‰ã€å‹•ç”»ç”Ÿæˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚

**å®Ÿè£…å†…å®¹:**
1. ç”»é¢æ“ä½œã®è¨˜éŒ²
2. éŸ³å£°ã¨ç”»é¢ã®åŒæœŸ
3. å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
4. å‹•ç”»ã®ä¿å­˜ã¨å†ç”Ÿ

---

## è©³ç´°å®Ÿè£…æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: éŸ³å£°ç”Ÿæˆæ©Ÿèƒ½ã®è¿½åŠ 

#### 1.1 è§£èª¬ãƒ†ã‚­ã‚¹ãƒˆã®æŠ½å‡º

```javascript
// js/video-generator.js ã‚’æ–°è¦ä½œæˆ

/**
 * è§£èª¬HTMLã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
 * @param {HTMLElement} container - è§£èª¬ã‚³ãƒ³ãƒ†ãƒŠ
 * @returns {Array<{text: string, element: HTMLElement}>} ãƒ†ã‚­ã‚¹ãƒˆã¨è¦ç´ ã®ãƒšã‚¢
 */
function extractExplanationText(container) {
  const sections = [];
  const cards = container.querySelectorAll('.card');
  
  cards.forEach((card, index) => {
    // è¦‹å‡ºã—ã‚’å–å¾—
    const heading = card.querySelector('h3, h4');
    const headingText = heading ? heading.textContent.trim() : '';
    
    // æœ¬æ–‡ã‚’å–å¾—ï¼ˆæ•°å¼ã¯èª­ã¿ä¸Šã’ç”¨ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ï¼‰
    const paragraphs = card.querySelectorAll('p');
    let text = headingText ? headingText + 'ã€‚' : '';
    
    paragraphs.forEach(p => {
      // MathJaxæ•°å¼ã‚’èª­ã¿ä¸Šã’å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
      const mathElements = p.querySelectorAll('.MathJax');
      let paragraphText = p.textContent;
      
      mathElements.forEach(math => {
        const mathText = convertMathToText(math);
        paragraphText = paragraphText.replace(math.textContent, mathText);
      });
      
      text += paragraphText.trim() + 'ã€‚';
    });
    
    if (text) {
      sections.push({
        index: index,
        text: text,
        element: card,
        heading: headingText
      });
    }
  });
  
  return sections;
}

/**
 * MathJaxæ•°å¼ã‚’èª­ã¿ä¸Šã’å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
 * @param {HTMLElement} mathElement - MathJaxè¦ç´ 
 * @returns {string} èª­ã¿ä¸Šã’ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
 */
function convertMathToText(mathElement) {
  // ç°¡å˜ãªå¤‰æ›ä¾‹
  const text = mathElement.textContent;
  return text
    .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '$1åˆ†ã®$2')
    .replace(/\^(\d+)/g, '$1ä¹—')
    .replace(/_(\d+)/g, 'ä¸‹ä»˜ã$1')
    .replace(/\\sqrt\{([^}]+)\}/g, 'ãƒ«ãƒ¼ãƒˆ$1')
    .replace(/\\pi/g, 'ãƒ‘ã‚¤')
    .replace(/\\theta/g, 'ã‚·ãƒ¼ã‚¿')
    .replace(/\\alpha/g, 'ã‚¢ãƒ«ãƒ•ã‚¡')
    .replace(/\\beta/g, 'ãƒ™ãƒ¼ã‚¿')
    .replace(/\\gamma/g, 'ã‚¬ãƒ³ãƒ')
    .replace(/=/g, 'ã‚¤ã‚³ãƒ¼ãƒ«')
    .replace(/\+/g, 'ãƒ—ãƒ©ã‚¹')
    .replace(/-/g, 'ãƒã‚¤ãƒŠã‚¹')
    .replace(/\*/g, 'ã‹ã‘ã‚‹')
    .replace(/\//g, 'ã‚ã‚‹');
}
```

#### 1.2 TTS APIã®çµ±åˆ

```javascript
// js/tts-service.js ã‚’æ–°è¦ä½œæˆ

/**
 * TTSã‚µãƒ¼ãƒ“ã‚¹ï¼ˆè¤‡æ•°ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å¯¾å¿œï¼‰
 */
class TTSService {
  constructor(provider = 'browser') {
    this.provider = provider;
    this.synthesis = null;
    
    if (provider === 'browser' && 'speechSynthesis' in window) {
      this.synthesis = window.speechSynthesis;
    }
  }
  
  /**
   * ãƒ†ã‚­ã‚¹ãƒˆã‚’éŸ³å£°ã«å¤‰æ›
   * @param {string} text - èª­ã¿ä¸Šã’ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
   * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
   * @returns {Promise<Blob>} éŸ³å£°ãƒ‡ãƒ¼ã‚¿
   */
  async synthesize(text, options = {}) {
    const defaultOptions = {
      lang: 'ja-JP',
      pitch: 1.0,
      rate: 1.0,
      volume: 1.0,
      voice: null
    };
    
    const opts = { ...defaultOptions, ...options };
    
    switch (this.provider) {
      case 'browser':
        return this.synthesizeBrowser(text, opts);
      case 'google':
        return this.synthesizeGoogle(text, opts);
      case 'openai':
        return this.synthesizeOpenAI(text, opts);
      default:
        throw new Error(`Unknown TTS provider: ${this.provider}`);
    }
  }
  
  /**
   * ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®Web Speech APIã‚’ä½¿ç”¨
   */
  synthesizeBrowser(text, options) {
    return new Promise((resolve, reject) => {
      if (!this.synthesis) {
        reject(new Error('Speech synthesis not supported'));
        return;
      }
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = options.lang;
      utterance.pitch = options.pitch;
      utterance.rate = options.rate;
      utterance.volume = options.volume;
      
      // æ—¥æœ¬èªéŸ³å£°ã‚’é¸æŠ
      const voices = this.synthesis.getVoices();
      const japaneseVoice = voices.find(v => 
        v.lang.startsWith('ja') && v.name.includes('Japanese')
      );
      if (japaneseVoice) {
        utterance.voice = japaneseVoice;
      }
      
      // éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€MediaRecorderã‚’ä½¿ç”¨
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const mediaStreamDestination = audioContext.createMediaStreamDestination();
      const mediaRecorder = new MediaRecorder(mediaStreamDestination.stream);
      const chunks = [];
      
      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) chunks.push(e.data);
      };
      
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        resolve(blob);
      };
      
      // æ³¨æ„: ãƒ–ãƒ©ã‚¦ã‚¶ã®Web Speech APIã¯ç›´æ¥Blobã‚’è¿”ã›ãªã„ãŸã‚ã€
      // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®TTSã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨
      
      utterance.onend = () => {
        mediaRecorder.stop();
      };
      
      utterance.onerror = (e) => {
        reject(new Error('Speech synthesis failed: ' + e.error));
      };
      
      this.synthesis.speak(utterance);
      mediaRecorder.start();
    });
  }
  
  /**
   * Google Cloud Text-to-Speech APIã‚’ä½¿ç”¨
   * ï¼ˆFirebase FunctionsçµŒç”±ï¼‰
   */
  async synthesizeGoogle(text, options) {
    const response = await fetch('/api/tts/google', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        text: text,
        languageCode: 'ja-JP',
        voiceName: 'ja-JP-Wavenet-A', // ã¾ãŸã¯ 'ja-JP-Neural2-A'
        audioEncoding: 'MP3',
        pitch: options.pitch,
        speakingRate: options.rate
      })
    });
    
    if (!response.ok) {
      throw new Error('TTS API request failed');
    }
    
    return await response.blob();
  }
  
  /**
   * OpenAI TTS APIã‚’ä½¿ç”¨
   */
  async synthesizeOpenAI(text, options) {
    const response = await fetch('/api/tts/openai', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        text: text,
        model: 'tts-1',
        voice: 'alloy', // 'alloy', 'echo', 'fable', 'onyx', 'nova', 'shimmer'
        speed: options.rate
      })
    });
    
    if (!response.ok) {
      throw new Error('OpenAI TTS API request failed');
    }
    
    return await response.blob();
  }
}
```

#### 1.3 éŸ³å£°ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã®è¿½åŠ 

```javascript
// js/audio-player.js ã‚’æ–°è¦ä½œæˆ

/**
 * è§£èª¬éŸ³å£°ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼
 */
class ExplanationAudioPlayer {
  constructor(container) {
    this.container = container;
    this.audioElement = null;
    this.currentSection = 0;
    this.sections = [];
    this.isPlaying = false;
    this.audioBlobs = [];
  }
  
  /**
   * è§£èª¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰éŸ³å£°ã‚’ç”Ÿæˆã—ã¦å†ç”Ÿ
   */
  async generateAndPlay(sections) {
    this.sections = sections;
    this.audioBlobs = [];
    
    // å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®éŸ³å£°ã‚’ç”Ÿæˆ
    const ttsService = new TTSService('google'); // ã¾ãŸã¯ 'openai'
    
    try {
      showLoading('éŸ³å£°ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...');
      
      for (let i = 0; i < sections.length; i++) {
        const section = sections[i];
        const audioBlob = await ttsService.synthesize(section.text, {
          lang: 'ja-JP',
          rate: 1.0
        });
        this.audioBlobs.push(audioBlob);
      }
      
      // éŸ³å£°ã‚’çµåˆ
      const combinedAudio = await this.combineAudioBlobs(this.audioBlobs);
      this.playAudio(combinedAudio);
      
      hideLoading();
    } catch (error) {
      console.error('Audio generation failed:', error);
      showError('éŸ³å£°ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      hideLoading();
    }
  }
  
  /**
   * è¤‡æ•°ã®éŸ³å£°Blobã‚’çµåˆ
   */
  async combineAudioBlobs(blobs) {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffers = [];
    
    for (const blob of blobs) {
      const arrayBuffer = await blob.arrayBuffer();
      const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
      audioBuffers.push(audioBuffer);
    }
    
    // çµåˆ
    const totalLength = audioBuffers.reduce((sum, buf) => sum + buf.length, 0);
    const combinedBuffer = audioContext.createBuffer(
      audioBuffers[0].numberOfChannels,
      totalLength,
      audioBuffers[0].sampleRate
    );
    
    let offset = 0;
    for (const buffer of audioBuffers) {
      for (let channel = 0; channel < buffer.numberOfChannels; channel++) {
        combinedBuffer.getChannelData(channel).set(
          buffer.getChannelData(channel),
          offset
        );
      }
      offset += buffer.length;
    }
    
    // AudioBufferã‚’Blobã«å¤‰æ›
    return this.audioBufferToBlob(combinedBuffer);
  }
  
  /**
   * AudioBufferã‚’Blobã«å¤‰æ›
   */
  audioBufferToBlob(audioBuffer) {
    // WAVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    const numberOfChannels = audioBuffer.numberOfChannels;
    const sampleRate = audioBuffer.sampleRate;
    const format = 1; // PCM
    const bitDepth = 16;
    
    const length = audioBuffer.length;
    const buffer = new ArrayBuffer(44 + length * numberOfChannels * 2);
    const view = new DataView(buffer);
    
    // WAVãƒ˜ãƒƒãƒ€ãƒ¼
    const writeString = (offset, string) => {
      for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
      }
    };
    
    writeString(0, 'RIFF');
    view.setUint32(4, 36 + length * numberOfChannels * 2, true);
    writeString(8, 'WAVE');
    writeString(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, format, true);
    view.setUint16(22, numberOfChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * numberOfChannels * 2, true);
    view.setUint16(32, numberOfChannels * 2, true);
    view.setUint16(34, bitDepth, true);
    writeString(36, 'data');
    view.setUint32(40, length * numberOfChannels * 2, true);
    
    // éŸ³å£°ãƒ‡ãƒ¼ã‚¿
    let offset = 44;
    for (let i = 0; i < length; i++) {
      for (let channel = 0; channel < numberOfChannels; channel++) {
        const sample = Math.max(-1, Math.min(1, audioBuffer.getChannelData(channel)[i]));
        view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
        offset += 2;
      }
    }
    
    return new Blob([buffer], { type: 'audio/wav' });
  }
  
  /**
   * éŸ³å£°ã‚’å†ç”Ÿ
   */
  playAudio(audioBlob) {
    const url = URL.createObjectURL(audioBlob);
    this.audioElement = new Audio(url);
    
    this.audioElement.addEventListener('play', () => {
      this.isPlaying = true;
      this.updateUI();
    });
    
    this.audioElement.addEventListener('pause', () => {
      this.isPlaying = false;
      this.updateUI();
    });
    
    this.audioElement.addEventListener('ended', () => {
      this.isPlaying = false;
      this.updateUI();
    });
    
    this.audioElement.addEventListener('timeupdate', () => {
      this.syncScroll();
    });
    
    this.audioElement.play();
  }
  
  /**
   * ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨éŸ³å£°ã‚’åŒæœŸ
   */
  syncScroll() {
    if (!this.audioElement || this.sections.length === 0) return;
    
    const currentTime = this.audioElement.currentTime;
    const totalDuration = this.audioElement.duration;
    const progress = currentTime / totalDuration;
    
    // ç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®š
    let accumulatedDuration = 0;
    for (let i = 0; i < this.sections.length; i++) {
      const sectionDuration = this.audioBlobs[i] ? 
        (this.audioBlobs[i].size / 16000) * 8 : 0; // æ¦‚ç®—
      accumulatedDuration += sectionDuration;
      
      if (currentTime <= accumulatedDuration) {
        if (this.currentSection !== i) {
          this.currentSection = i;
          this.scrollToSection(i);
        }
        break;
      }
    }
  }
  
  /**
   * æŒ‡å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
   */
  scrollToSection(index) {
    if (this.sections[index] && this.sections[index].element) {
      this.sections[index].element.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
      });
      
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
      this.highlightSection(index);
    }
  }
  
  /**
   * ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
   */
  highlightSection(index) {
    // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
    this.sections.forEach(section => {
      section.element.classList.remove('audio-playing');
    });
    
    // ç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    if (this.sections[index]) {
      this.sections[index].element.classList.add('audio-playing');
    }
  }
  
  /**
   * UIã‚’æ›´æ–°
   */
  updateUI() {
    const playButton = document.getElementById('audio-play-btn');
    const pauseButton = document.getElementById('audio-pause-btn');
    
    if (playButton) playButton.style.display = this.isPlaying ? 'none' : 'inline';
    if (pauseButton) pauseButton.style.display = this.isPlaying ? 'inline' : 'none';
  }
  
  pause() {
    if (this.audioElement) {
      this.audioElement.pause();
    }
  }
  
  resume() {
    if (this.audioElement) {
      this.audioElement.play();
    }
  }
  
  stop() {
    if (this.audioElement) {
      this.audioElement.pause();
      this.audioElement.currentTime = 0;
    }
    this.isPlaying = false;
    this.updateUI();
  }
}
```

---

## ä½¿ç”¨å¯èƒ½ãªTTSã‚µãƒ¼ãƒ“ã‚¹

### 1. Google Cloud Text-to-Speechï¼ˆæ¨å¥¨ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- é«˜å“è³ªãªæ—¥æœ¬èªéŸ³å£°
- è‡ªç„¶ãªç™ºéŸ³
- Firebaseã¨ã®çµ±åˆãŒå®¹æ˜“

**æ–™é‡‘:**
- æœ€åˆã®100ä¸‡æ–‡å­—/æœˆã¯ç„¡æ–™
- ãã®å¾Œ $4.00 / 100ä¸‡æ–‡å­—

**å®Ÿè£…ä¾‹:**
```javascript
// Firebase Functions
const textToSpeech = require('@google-cloud/text-to-speech');
const client = new textToSpeech.TextToSpeechClient();

exports.generateTTS = functions.https.onCall(async (data, context) => {
  const request = {
    input: { text: data.text },
    voice: { 
      languageCode: 'ja-JP',
      name: 'ja-JP-Wavenet-A',
      ssmlGender: 'NEUTRAL'
    },
    audioConfig: { 
      audioEncoding: 'MP3',
      speakingRate: data.rate || 1.0
    }
  };
  
  const [response] = await client.synthesizeSpeech(request);
  return response.audioContent.toString('base64');
});
```

### 2. OpenAI TTS API

**ãƒ¡ãƒªãƒƒãƒˆ:**
- éå¸¸ã«è‡ªç„¶ãªéŸ³å£°
- ã‚·ãƒ³ãƒ—ãƒ«ãªAPI
- è¤‡æ•°ã®éŸ³å£°ã‚¹ã‚¿ã‚¤ãƒ«

**æ–™é‡‘:**
- $15.00 / 100ä¸‡æ–‡å­—

**å®Ÿè£…ä¾‹:**
```javascript
const response = await fetch('https://api.openai.com/v1/audio/speech', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${OPENAI_API_KEY}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    model: 'tts-1',
    input: text,
    voice: 'alloy',
    speed: 1.0
  })
});
```

### 3. Azure Text-to-Speech

**ãƒ¡ãƒªãƒƒãƒˆ:**
- é«˜å“è³ª
- ã‚«ã‚¹ã‚¿ãƒ éŸ³å£°å¯¾å¿œ

**æ–™é‡‘:**
- æœ€åˆã®50ä¸‡æ–‡å­—/æœˆã¯ç„¡æ–™
- ãã®å¾Œ $15.00 / 100ä¸‡æ–‡å­—

### 4. ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ï¼ˆWeb Speech APIï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ç„¡æ–™
- è¿½åŠ è¨­å®šä¸è¦

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- å“è³ªãŒé™å®šçš„
- ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜
- éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒå›°é›£

---

## å‹•ç”»ç”Ÿæˆã®å®Ÿè£…

### æ–¹æ³•1: MediaRecorder APIï¼ˆãƒ–ãƒ©ã‚¦ã‚¶éŒ²ç”»ï¼‰

```javascript
// js/video-recorder.js

class ExplanationVideoRecorder {
  constructor() {
    this.mediaRecorder = null;
    this.recordedChunks = [];
    this.audioPlayer = null;
  }
  
  /**
   * è§£èª¬å‹•ç”»ã‚’éŒ²ç”»
   */
  async startRecording(container, audioPlayer) {
    this.audioPlayer = audioPlayer;
    
    // ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’å–å¾—
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: { 
        mediaSource: 'screen',
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: true
    });
    
    // MediaRecorderã§éŒ²ç”»
    this.mediaRecorder = new MediaRecorder(stream, {
      mimeType: 'video/webm;codecs=vp9'
    });
    
    this.recordedChunks = [];
    
    this.mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        this.recordedChunks.push(event.data);
      }
    };
    
    this.mediaRecorder.onstop = () => {
      const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
      this.downloadVideo(blob);
    };
    
    // éŸ³å£°å†ç”Ÿã¨åŒæ™‚ã«éŒ²ç”»é–‹å§‹
    this.mediaRecorder.start();
    audioPlayer.resume();
    
    // éŸ³å£°çµ‚äº†æ™‚ã«éŒ²ç”»åœæ­¢
    audioPlayer.audioElement.addEventListener('ended', () => {
      this.stopRecording();
    });
  }
  
  stopRecording() {
    if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
      this.mediaRecorder.stop();
    }
  }
  
  downloadVideo(blob) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `explanation-${Date.now()}.webm`;
    a.click();
    URL.revokeObjectURL(url);
  }
}
```

### æ–¹æ³•2: Canvas + FFmpegï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼‰

ã‚ˆã‚Šé«˜å“è³ªãªå‹•ç”»ã‚’ç”Ÿæˆã™ã‚‹å ´åˆã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§FFmpegã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```javascript
// Firebase Functions
const ffmpeg = require('fluent-ffmpeg');
const { Storage } = require('@google-cloud/storage');

exports.generateVideo = functions.https.onCall(async (data, context) => {
  // 1. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
  const audioBuffer = Buffer.from(data.audioBase64, 'base64');
  
  // 2. ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒã‚’å–å¾—ï¼ˆäº‹å‰ã«ä¿å­˜ï¼‰
  const screenshots = data.screenshots; // Base64ç”»åƒã®é…åˆ—
  
  // 3. FFmpegã§å‹•ç”»ã‚’ç”Ÿæˆ
  const outputPath = `/tmp/output-${Date.now()}.mp4`;
  
  await new Promise((resolve, reject) => {
    ffmpeg()
      .input(audioBuffer)
      .inputFPS(1)
      .inputFormat('mp3')
      .videoCodec('libx264')
      .audioCodec('aac')
      .outputOptions([
        '-pix_fmt yuv420p',
        '-r 30'
      ])
      .on('end', resolve)
      .on('error', reject)
      .save(outputPath);
  });
  
  // 4. å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const storage = new Storage();
  const bucket = storage.bucket('your-bucket-name');
  await bucket.upload(outputPath);
  
  return { videoUrl: `gs://your-bucket-name/${outputPath}` };
});
```

---

## çµ±åˆæ–¹æ³•

### viewer.htmlã¸ã®çµ±åˆ

```html
<!-- viewer.html ã«è¿½åŠ  -->
<div class="audio-controls" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
  <button id="audio-generate-btn" class="btn-audio">ğŸ¤ éŸ³å£°ç”Ÿæˆ</button>
  <button id="audio-play-btn" class="btn-audio" style="display: none;">â–¶ï¸ å†ç”Ÿ</button>
  <button id="audio-pause-btn" class="btn-audio" style="display: none;">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
  <button id="video-record-btn" class="btn-audio">ğŸ“¹ å‹•ç”»éŒ²ç”»</button>
</div>
```

```javascript
// js/viewer.js ã«è¿½åŠ 

let audioPlayer = null;
let videoRecorder = null;

document.addEventListener('DOMContentLoaded', () => {
  // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
  
  // éŸ³å£°ç”Ÿæˆãƒœã‚¿ãƒ³
  const generateBtn = document.getElementById('audio-generate-btn');
  if (generateBtn) {
    generateBtn.addEventListener('click', async () => {
      const container = document.getElementById('text-target');
      const sections = extractExplanationText(container);
      
      audioPlayer = new ExplanationAudioPlayer(container);
      await audioPlayer.generateAndPlay(sections);
    });
  }
  
  // å‹•ç”»éŒ²ç”»ãƒœã‚¿ãƒ³
  const recordBtn = document.getElementById('video-record-btn');
  if (recordBtn) {
    recordBtn.addEventListener('click', async () => {
      if (!audioPlayer) {
        alert('ã¾ãšéŸ³å£°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
        return;
      }
      
      videoRecorder = new ExplanationVideoRecorder();
      const container = document.getElementById('text-target');
      await videoRecorder.startRecording(container, audioPlayer);
    });
  }
});
```

### CSSã®è¿½åŠ 

```css
/* css/viewer.css ã«è¿½åŠ  */

.audio-controls {
  display: flex;
  gap: 10px;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-audio {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  background: #3b82f6;
  color: white;
  cursor: pointer;
  font-size: 14px;
}

.btn-audio:hover {
  background: #2563eb;
}

.card.audio-playing {
  background: #fef3c7;
  border-left: 4px solid #f59e0b;
  transition: background 0.3s;
}
```

---

## å®Ÿè£…ã®å„ªå…ˆé †ä½

### ãƒ•ã‚§ãƒ¼ã‚º1: éŸ³å£°å†ç”Ÿæ©Ÿèƒ½ï¼ˆ1-2é€±é–“ï¼‰
1. ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºæ©Ÿèƒ½
2. TTS APIçµ±åˆï¼ˆGoogle Cloud TTSæ¨å¥¨ï¼‰
3. éŸ³å£°ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼
4. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸ

### ãƒ•ã‚§ãƒ¼ã‚º2: å‹•ç”»ç”Ÿæˆæ©Ÿèƒ½ï¼ˆ2-3é€±é–“ï¼‰
1. MediaRecorder APIå®Ÿè£…
2. éŸ³å£°ã¨ç”»é¢ã®åŒæœŸ
3. å‹•ç”»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½

### ãƒ•ã‚§ãƒ¼ã‚º3: é«˜åº¦ãªæ©Ÿèƒ½ï¼ˆ1-2é€±é–“ï¼‰
1. å‹•ç”»ã®ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜
2. å‹•ç”»ã®å…±æœ‰æ©Ÿèƒ½
3. å“è³ªã®æœ€é©åŒ–

---

## ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

### Google Cloud TTS
- **ç„¡æ–™æ **: 100ä¸‡æ–‡å­—/æœˆ
- **è¿½åŠ **: $4.00 / 100ä¸‡æ–‡å­—
- **ä¾‹**: 1å•é¡Œã‚ãŸã‚Šç´„2000æ–‡å­— â†’ 500å•é¡Œ/æœˆã¾ã§ç„¡æ–™

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆå‹•ç”»ï¼‰
- **Firebase Storage**: $0.026 / GB/æœˆ
- **å‹•ç”»ã‚µã‚¤ã‚º**: ç´„10MB/å•é¡Œï¼ˆ5åˆ†å‹•ç”»æƒ³å®šï¼‰
- **100å•é¡Œ**: ç´„1GB â†’ $0.026/æœˆ

---

## ã¾ã¨ã‚

âœ… **AIéŸ³å£°ã«ã‚ˆã‚‹è§£èª¬å‹•ç”»ã¯å®Œå…¨ã«å®Ÿç¾å¯èƒ½ã§ã™**

**æ¨å¥¨å®Ÿè£…:**
1. **éŸ³å£°ç”Ÿæˆ**: Google Cloud Text-to-Speechï¼ˆé«˜å“è³ªãƒ»ä½ã‚³ã‚¹ãƒˆï¼‰
2. **å‹•ç”»ç”Ÿæˆ**: MediaRecorder APIï¼ˆç°¡å˜ï¼‰ã¾ãŸã¯FFmpegï¼ˆé«˜å“è³ªï¼‰
3. **çµ±åˆ**: æ—¢å­˜ã®viewer.htmlã«çµ±åˆ

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
1. Firebase Functionsã§TTS APIã‚’å®Ÿè£…
2. éŸ³å£°ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã‚’è¿½åŠ 
3. å‹•ç”»éŒ²ç”»æ©Ÿèƒ½ã‚’è¿½åŠ 

å®Ÿè£…ã‚’é–‹å§‹ã™ã‚‹å ´åˆã¯ã€ã©ã®éƒ¨åˆ†ã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ
