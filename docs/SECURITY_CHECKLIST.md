# セキュリティ確認手順（公開リポジトリ用）

リポジトリを public にする前に、次の2つを確認してください。

---

## 1. Firebase API キーに HTTP リファラー制限をかける

### どこでやるか
**Firebase コンソール**（または Google Cloud コンソールの「認証情報」）で設定します。

### 手順（Firebase コンソール）

1. ブラウザで **https://console.firebase.google.com/** を開く。

2. 左メニュー下部の **⚙️ 歯車** をクリック → **「プロジェクトの設定」** を開く。

3. **「一般」** タブを開いたまま、下にスクロールして **「マイアプリ」** の一覧を確認する。

4. 対象の **ウェブアプリ**（Physics Lab. のアイコン）の行にある **「アプリの制限」** または **「キーの制限」** のリンクをクリックする。  
   - または、同じページの **「ウェブ API キー」** の横にあるキー（`AIza...`）をクリックすると、Google Cloud の「認証情報」ページに飛びます。

5. **Google Cloud コンソールに飛んだ場合**（認証情報ページ）:
   - 一覧から **「API キー」** の種類の該当キー（ブラウザ用のキー）をクリック。
   - **「アプリの制限」** で **「HTTP リファラー（ウェブサイト）」** を選択。
   - **「ウェブサイトの制限」** で **「リファラーを追加」** をクリックし、次のように1行ずつ追加する（あなたの実際のドメインに合わせて変更）:
     ```
     https://rikeich-q.web.app/*
     https://rikeich-q.firebaseapp.com/*
     ```
     カスタムドメインを使っている場合は例:
     ```
     https://あなたのドメイン.com/*
     ```
   - **「保存」** をクリック。

6. **Firebase の「プロジェクトの設定」から「キーの制限」に飛べる場合**:
   - 同様に **HTTP リファラー** を選び、上記の URL パターンを追加して保存。

### 確認のしかた
- 制限をかけたあと、**本番のサイト**（rikeich-q.web.app など）で生徒画面・解説が開き、リアクションやメモが保存できれば OK です。
- **GitHub の raw や GitHub Pages の URL** からはキーが拒否される想定です（制限が効いている証拠）。

---

## 2. サービスアカウント JSON や秘密鍵をコミットしていないか確認する

### 何を探すか
- **サービスアカウント鍵**  
  Firebase や GCP からダウンロードした `xxx.json`（中に `"private_key"` や `"client_email"` が含まれるもの）。
- **秘密鍵ファイル**  
  `.pem` やパスワード・トークンが書かれたファイル。

### 手順（リポジトリ内の検索）

#### 方法A: 検索コマンド（PowerShell または Git Bash）

リポジトリのルート（`rikeich_q` フォルダ）で:

```powershell
# 「private_key」という文字列が含まれるファイルを探す（秘密鍵の代表的なキー名）
git grep -i "private_key"

# 「client_email」を探す（サービスアカウント JSON によくある項目）
git grep -i "client_email"
```

**どちらも「何も出てこない」** か、出てきても **ドキュメントの説明文だけ**（例: 「client_email を設定しないでください」）であれば問題ありません。  
実際の鍵やメールアドレスが書かれた行が出てきたら、そのファイルは削除し、キーを再発行してください。

#### 方法B: GitHub の検索（すでに GitHub に push している場合）

1. リポジトリのページで **検索ボックス** を使う。
2. 検索: `private_key` または `client_email`。
3. **コード** を選んで検索し、**設定ファイルやドキュメント以外**でヒットしていないか確認する。

#### 方法C: ファイル名で確認

次のようなファイルが **リポジトリ内にないか** フォルダをざっと見る:

- `*-service-account*.json`
- `*firebase*admin*.json`
- `*.pem`
- `credentials.json`
- `secret*.json`

**こうしたファイルがリポジトリのどれかのフォルダにない**ことを確認すれば OK です。  
（`.gitignore` に `*.pem` や `*-service-account*.json` を入れておくと、今後うっかりコミットしにくくなります。）

### 結果の目安

- **`git grep` で何もヒットしない**（またはヒットがドキュメントのみ）  
  → サービスアカウント JSON や秘密鍵はコミットされていないと判断してよいです。
- **ヒットした**  
  → 該当ファイルを削除し、その鍵は無効化・再発行し、必要なら `git filter-branch` や BFG で履歴からも削除する必要があります（その場合は別途手順を検討してください）。

---

## まとめ

| 項目 | やること |
|------|----------|
| HTTP リファラー制限 | Firebase / Google Cloud で API キーに「HTTP リファラー」を設定し、本番ドメインのみ許可する。 |
| 秘密の有無 | リポジトリで `private_key` と `client_email` を検索し、実際の鍵やメールが含まれるファイルが無いことを確認する。 |

両方できていれば、リポジトリを public にしても問題ない状態です。
