# Physics Lab. アプリ改善点分析

本ドキュメントは、理系チャンネル問題解説ビューアー（Physics Lab.）のコードベース・UX・運用観点での改善点を整理したものです。

---

## 1. コード規約・一貫性

### 1.1 ES5 と ES6 の混在（.cursorrules との不整合）

**現状**  
`.cursorrules` では「解説ページ・シミュレーション用は ES5 互換（`var` / `function` / 文字列連結）」とある一方、**アプリ本体の JS**（`js/index.js`, `js/viewer.js`, `js/error-handler.js`, `js/pointer.js` 等）は `const` / `let` / アロー関数 / テンプレートリテラルを多用しています。

**改善案**
- **方針を明確化する**
  - **A案**: アプリ本体はモダンブラウザ前提とし、ES6+ を許容。`.cursorrules` の ES5 ルールを「解説HTML・埋め込みシミュ内のインラインスクリプトのみ」に限定して記載する。
  - **B案**: 本当に古い環境対応が必要なら、アプリ本体も `var` / `function` に揃え、ビルドでトランスパイルする。
- 現状のままだと「解説は ES5」「アプリは ES6」で一貫しており、**ドキュメントでその棲み分けを明示**しておくと運用しやすいです。

---

## 2. ナビゲーション・サイト構造

### 2.1 フッターのリンク不統一

**現状**
- **hub.html**: ハブ | このサイトについて | プライバシーポリシー | Physics Lab.
- **index.html** / **viewer.html** / **about.html**: このサイトについて | プライバシーポリシー | Physics Lab.（**ハブへのリンクなし**）

**改善案**
- 全ページのフッターに「ハブ」リンクを追加し、`hub.html` ↔ 各画面の行き来を統一する。
- または「トップ（index）」「ハブ」の役割をルールで決め、フッターは「ハブ | このサイトについて | プライバシー | トップ」のように共通テンプレート化する。

### 2.2 ハブからの戻り先

**現状**  
about.html の「トップへ戻る」は `index.html` 固定。ハブ経由で来たユーザーは「ハブに戻る」が選べない。

**改善案**
- 「トップへ戻る」に加え「ハブへ戻る」を用意するか、`document.referrer` やセッションで「どこから来たか」を考慮して戻り先を変える（任意）。

---

## 3. アクセシビリティ（a11y）

### 3.1 スキップリンク

**良い点**  
`index.html`, `hub.html`, `viewer.html` に「メインコンテンツへスキップ」の skip-link がある。

**改善案**
- `about.html`, `privacy.html`, `test.html`, `admin.html` にも同様の skip-link を追加する。
- スキップ先の `id`（例: `#main-content`, `#hub-main`）が確実に存在することを確認する。

### 3.2 フォーカス・キーボード操作

**改善案**
- モーダル（QRコード等）を開いたとき、フォーカスをモーダル内に移し、閉じたらトリガーボタンに戻す（フォーカストラップ）。
- タブ切り替え（教材タブ・入試サブタブ）をキーボード（矢印キー）で操作できるようにすると、キーボードユーザーに優しい。

### 3.3 ランドマーク・見出し

**改善案**
- 教材一覧の「科目カード」が `<section>` や適切な見出し階層（h2 等）で囲まれているか確認する。
- 検索結果が 0 件のときに、スクリーンリーダー向けに `aria-live` で「該当する問題はありません」などを読み上げるようにする。

---

## 4. パフォーマンス・読み込み

### 4.1 解説ページのリソース

**現状**  
viewer では MathJax を遅延読み込みし、シミュ用ライブラリ（p5.js, Three.js, Matter.js 等）は解説に `sim-embed` があるときのみ読み込む方針の記載がある。

**改善案**
- 実際に「sim-embed があるときだけスクリプトを読む」実装になっているか確認する。未使用教材のスクリプトを読まないようにすると初回表示が軽くなる。
- 画像がある解説では `loading="lazy"` や適切な `width`/`height` で CLS を抑える。

### 4.2 Service Worker のキャッシュ範囲

**現状**  
`sw.js` は `/data/explanations/` と `/data/materials/` のみキャッシュ。HTML や CSS/JS はキャッシュしていない。

**改善案**
- オフラインでも「トップ・ハブ・about」程度は見られるように、重要な静的 HTML/CSS/JS をキャッシュに含める選択肢がある。
- その場合、`CACHE_NAME` のバージョンアップとデプロイ手順（`npm run deploy`）は現状どおり維持する。

---

## 5. エラーハンドリング・堅牢性

### 5.1 エラー表示の前提

**現状**  
`showToast` が `#app-toast-container` を自動作成する。`ErrorHandler.handle` でユーザーにメッセージを表示している。

**改善案**
- トーストの最大表示数や、同じメッセージの連続表示抑制を検討する。
- ネットワークエラー時、「再試行」ボタンをトーストや空状態に出すと親切。

### 5.2 ブックマーク・localStorage

**現状**  
ブックマークは `localStorage` の `rikeich_bookmarks` に保存。`getBookmarksList()` でパース失敗時は空配列を返している。

**改善案**
- ストレージが満杯で `setItem` が失敗した場合のフォールバック（トーストで「保存できませんでした」等）を入れる。
- 必要なら「ブックマークをエクスポート/インポート」機能を検討する。

### 5.3 外部 API 依存（QR コード）

**現状**  
index の QR モーダルで、QRCode ライブラリが無い場合は `https://api.qrserver.com/...` に画像を頼っている。

**改善案**
- 外部 API が落ちたときのフォールバック（「QRコードを表示できません」＋URL のテキスト表示は現状どおり）を明示する。
- プライバシー・可用性の観点で、可能なら QR 用ライブラリをプロジェクトに含め、外部 API は補助に留める選択肢がある。

---

## 6. セキュリティ

### 6.1 XSS 対策

**現状**  
`escapeHtml` が `error-handler.js` にあり、index/viewer で表示用文字列に使われている。解説 HTML は `fetch` で取ったあと `innerHTML` で流し込んでいる可能性がある。

**改善案**
- 解説 HTML の注入元（自前の `data/explanations/` のみか、ユーザー入力が混ざるか）を明確にする。
- もし信頼できない HTML が混ざる可能性があるなら、DOMPurify 等でサニタイズするか、表示を「テキスト＋信頼タグのみ」に制限する。

### 6.2 Firebase・管理者画面

**現状**  
admin は Firebase（Firestore）を使用。`config/firebase-config.js` で設定を読み込んでいる。

**改善案**
- 管理者画面（admin.html）へのアクセス制御（認証・許可リスト等）がどうなっているか確認する。
- API キー等がクライアントに露出しないよう、必要なら Cloud Functions 等でサーバー側に寄せる。

---

## 7. UX・UI

### 7.1 検索

**現状**  
問題の検索は `data-search-text`（path + title）に対するクライアント側の部分一致。日本語・英数字で動作している。

**改善案**
- 検索キーワードを URL クエリ（例: `?q=波`）に載せ、共有・ブックマークで「この検索結果」を再現できるようにする。
- 検索結果件数（「3 件」等）を表示すると分かりやすい。

### 7.2 教員モードの入口

**現状**  
`index.html?mode=teacher` で教員画面。ハブの「教員画面」からこれに飛ぶ。URL を共有しないと教員モードにならない。

**改善案**
- 教員モードであることを画面上で軽く表示する（バッジや小さなラベル）。誤って生徒に教員モード URL を渡したときの注意喚起にもなる。

### 7.3 ブックマーク一覧

**現状**  
「⭐ ブックマーク一覧」で `#bookmarks` に飛び、同じページ内のセクションで表示。

**改善案**
- ブックマークが 0 件のとき、リンクを非表示にする現状でよいが、「ブックマークの並び替え」「削除」を一覧内でできるようにすると便利。
- 生徒/教員で別リストにする必要があるか検討する（現状は共通でよければそのままでも可）。

### 7.4 解説ビューアの「戻る」

**現状**  
viewer の戻るボタンは `index.html`（または path から算出した index）に戻る。履歴は `pushState` で上書きされ、ブラウザの「戻る」では解説から離れない設計。

**改善案**
- 「一覧に戻る」と「前の解説に戻る」を両方用意するかどうかは、利用シーンに合わせて検討する。

---

## 8. データ・コンテンツ管理

### 8.1 マニフェストと JSON の整合

**現状**  
`data/manifest.json` で教材一覧を定義し、各 `data/materials/*.json` で編・章・問題を定義。解説 HTML は `explanationPath` で参照。

**改善案**
- 解説を追加する際、`explanationPath` の実ファイル存在チェックをスクリプトや CI で行うと、404 を防げる。
- サンプル用リンク（hub の「総合演習」等）のパス（`001_p12_ex1.html`）が実在するか定期的に確認する。

### 8.2 解説 HTML のテンプレート遵守

**現状**  
`.cursorrules` で「解法の全体像 → 各設問の解説 → 解法のポイント」の順序や、`box-note` / `sim-embed` などのルールが定められている。

**改善案**
- 新規作成・修正時に、簡易的な HTML 構造チェック（必須 class や h3 の有無）をスクリプトで実行できると、ルール逸脱を防ぎやすい。

---

## 9. テスト・品質

### 9.1 test.html の役割

**現状**  
解説 HTML の即時テスト環境。CDN で p5/Three/Matter/JSXGraph/Chart を読み込み、MathJax も読み込み済み。

**改善案**
- テスト用に「どの解説パスを開くか」を URL パラメータで指定できるようにすると、CI やリンク共有で同じ画面を再現しやすい。
- 可能なら、主要画面（index / viewer の基本表示）の簡単な E2E やスナップショットを検討する。

### 9.2 リンク切れチェック

**改善案**
- `data/materials/*.json` の全 `explanationPath` に対して、実際に GET で 200 が返るかチェックするスクリプトを用意する（Node や GitHub Actions で定期実行など）。

---

## 10. ドキュメント・運用

### 10.1 .cursorrules の更新

**改善案**
- 「アプリ本体の JS は ES6 可」「解説 HTML 内は ES5」のように、適用範囲を明記する。
- ハブ・index・viewer の役割と、推奨入口（ハブ or トップ）を 1 行で書いておくと、今後の変更時にも迷いにくい。

### 10.2 デプロイ・キャッシュ

**現状**  
`npm run deploy` でキャッシュ名を上げてから Firebase デプロイ。`.cursorrules` に手順が書かれている。

**改善案**
- デプロイ後の確認手順（「トップ → 教材選択 → 解説表示 → オフラインで再表示」等）を README や運用メモに残す。
- キャッシュ名の付け方（v7 等）をどこで管理しているか（package.json のスクリプト等）を一箇所にまとめておく。

---

## 改善優先度の目安（例）

| 優先度 | 項目 |
|--------|------|
| 高     | フッターのハブリンク統一、解説 path の存在チェック、エラー時の再試行 |
| 中     | 検索結果の件数表示・URL 連携、全ページの skip-link、QR の外部 API 依存見直し |
| 低     | キーボード操作の拡張、ブックマーク並び替え、E2E テスト |

---

## 実施した改善（優先事項）

以下の修正を実施済みです。

- **フッターのハブリンク統一**  
  `index.html` / `viewer.html` / `about.html` / `privacy.html` のフッターに「ハブ」リンクを追加し、`hub.html` と同一の並びに統一しました。
- **解説 path の存在チェック**  
  `scripts/check-explanation-paths.js` を追加。`data/manifest.json` と各 `data/materials/*.json` から全 `explanationPath` を収集し、ファイルの存在を検証します。  
  実行: `npm run check-paths` または `node scripts/check-explanation-paths.js`。不足がある場合は exit code 1 で一覧を表示します。
- **エラー時の再試行**  
  教材リスト（マニフェスト）または教材 JSON の読み込みに失敗したとき、エラー文言に加えて「再試行」ボタンを表示。クリックで同じ読み込みを再度実行します。
- **about / privacy のスキップリンク**  
  `about.html` と `privacy.html` に「メインコンテンツへスキップ」リンクを追加し、メインコンテンツ領域に `id` と `role="main"` を付与しました。
- **検索結果の件数表示**  
  問題検索時に、検索キーワードに一致した件数（「○ 件」）を検索欄横に表示するようにしました。

---

以上を踏まえ、まずは「ナビゲーション統一」「ES5/ES6 の適用範囲の明文化」「解説 path の検証スクリプト」から手を付けると効果が大きいです。
