# 理系チャンネル 問題解説ビューアー - Cursor管理ルール

## プロジェクト概要
このプロジェクトは高校物理のWeb教材開発システムです。Cursorのチャットで画像やPDFをアップロードすると、自動的に解説ページが生成・追加されるワークフローを実装しています。

## 画像・PDFアップロード時の自動処理ルール

### 1. アップロード検知と処理フロー
ユーザーがCursorチャットに画像やPDFをアップロードした場合、以下の手順で**すべて1回の応答で完了**させる：

1. **問題の特定**: アップロードされた画像/PDFから問題文、図、数値条件を読み取る
2. **教材情報の特定**: 画像中のヘッダー（例:「物基707」「演習問題1」等）やユーザー指示から教材タイプ・編・章・問題番号を特定する。指示に含まれている場合は確認不要（例:「物理基礎教科書の03>02の16.html」→ textbook_basic/03/02/16）
3. **シミュレーション付き解説HTMLの生成**: 以下を**必ず含む**解説ページを生成する
   - **問題状況を再現するシミュレーション**（★最重要・後述の §1.1 参照。基本は p5.js、問題の状況に応じて Three.js 等も使用可）
   - 各小問の解説（導出・式・図）
   - 解法のポイント
4. **HTMLファイルの保存**: explanationPath に基づいて保存
5. **マニフェストJSONへの登録**: 該当する `data/materials/{教材ID}.json` の正しい編・章の `problems` 配列に追加
6. **完了報告**: 保存パス・登録先・シミュの概要を表示

### §1.1 問題状況シミュレーションの自動生成（★必須）

**問題の画像がアップロードされた場合、その図に描かれた実験装置・物理状況を忠実に再現するシミュレーションを必ず「解法の全体像」カード内に生成すること。これは省略不可である。**

**ライブラリの選択**（問題の状況に応じて使い分ける）：
- **基本は p5.js**：2Dの実験図・波形・定常波・単振動・斜面・滑車など、多くの問題は p5.js で十分に再現できる。
- **Three.js**：3D空間が必要な問題（球の衝突、剛体の回転、電場・磁場の向きを3軸で示す、光学系など）では Three.js を使用する。
- **Matter.js**：接触・衝突・拘束が複雑な力学問題では Matter.js の物理演算を利用する。
- **JSXGraph / Chart.js**：グラフの読み取り・作図が主な設問の場合は JSXGraph や Chart.js を検討する。

具体的な手順：
1. **図の読み取り**: 画像中の装置・物体の形状（おんさ、滑車、ばね、台車、斜面など）を正確に把握する
2. **形状の忠実再現**: 選んだライブラリの描画機能（p5.js: rect, ellipse, triangle, arc 等／Three.js: Mesh, Line 等）で教科書の図に近づけて描く。単純な矩形や丸だけで済ませない
3. **物理的な動き**: 定常波の振動、物体の運動など、問題で扱う物理現象をアニメーションで表現する
4. **ラベルと寸法**: 問題文中の記号（A, B, C, R, f 等）をシミュレーション上に表示する
5. **操作UI**: スライダー・ボタン等で、パラメータを変えて現象を確認できるようにする
6. **ラベル・文字の重なり防止**: シミュレーション内では文字やラベルが重なりやすいため、**配置時に重ならないよう十分な余白・位置調整を行うこと**。矢印と数値、管とラベルなど、複数要素が近い場合は特に注意する。

**過去の失敗例と対策**:
- ❌ 解説テキストだけ生成してシミュレーションを含めなかった → 後から追加を依頼された
- ✅ 最初の応答で、図の忠実な再現シミュを含む完全な解説HTMLを生成する

### 2. 解説ページ生成の基本ルール

#### 2.1 解説ページの標準構成（厳守）

**全解説ページは、次の3部構成で統一する。順序の入れ替えやセクションの省略は禁止。**

| 順序 | セクション名（h3） | 内容 |
| :--- | :--- | :--- |
| **1** | **解法の全体像** | 解法の流れの全体像。どの法則・どの順で解くかを簡潔に示す。物理現象の核となる考え方。 |
| **2** | **各設問の解説** | 設問(1),(2)... ごとに card で区切り、下記の「設問解説の必須要素」を満たす。 |
| **3** | **解法のポイント** | ページ最後に `<div class="box-alert">` で、この問題から得られる普遍的なポイントを箇条書き。**解答の一覧（答一覧・answer-table）は含めない。** |

- 見出し表記の統一：冒頭は必ず **「解法の全体像」**（「解法の指針」など別名にしない）。最後のまとめは **「解法のポイント」** または **「解法のポイントまとめ」** とする。

#### 2.2 設問解説の必須要素（各小問 card 内）

各設問ごとに以下を満たすこと：

- **問題で聞かれている内容の簡潔な説明**：何を求める設問かを最初に明確にする。
- **導出プロセス**：図解を交えた立式から計算まで、高校物理の範囲内で丁寧に解説。
- **図・シミュレーション**：**原則として各小問に少なくとも1つ以上**、図またはシミュレーションを含める。Matter.js, JSXGraph, Chart.js, p5.js, Three.js 等を使用し、**見やすく精密な**可視化にする。
- **補足・別解**：直感的に分かりにくい部分の補足、微積による別解などがあれば**積極的に追加**する。必要に応じて「コラム：大学物理への橋渡し」も可。
- **答えのタグ付け**：各設問の**答え**（数式・数値・選択肢番号・記号解答など）は、必ず **`<div class="box-note">`** で囲む。答えだけが `<p>` 内に書かれている場合は、その部分を box-note に移すか、直後に box-note を追加して答を明示する。

#### 2.3 禁止事項（解説ページ）

- **答一覧・解答一覧**：`答一覧` という見出しや、全設問の答えを一覧にした表（`answer-table`）は**作成しない・既存ページを増築する際も追加しない**。各設問の card 内の box-note で答を示す形式にとどめる。
- 上記 2.1 の順序・セクション名の変更禁止。

#### 2.4 著作権・引用のルール（厳守）

解説ページを作成・生成する際は、以下のルールを必ず守ってください。

- **問題文**
  - 出版社・大学等が著作権を有するため、**全文を転載しない**。解説の理解に必要な範囲で**最小限の引用**にとどめる。
  - 引用する場合は、**出典を明記**する（例：教材名・出版社・年度・問題番号）。`prob-title-sub` や解説冒頭で「〇〇 2024年 第3問」のように分かる形で記載する。
- **図・表**
  - 教科書・問題集の図をそのままスキャン・転用しない。**解説用の図・シミュレーションはすべてオリジナルで作成**する（Matter.js, JSXGraph, p5.js 等で描画）。
- **解説本文**
  - 解法・式の導出・概念説明・シミュレーションは**当サイトのオリジナル**として作成する。他サイトや書籍の解説の無断転載は禁止。

これにより、市販問題集・入試問題の解説ページでも、収益化（広告等）が適切に運用できる状態を保ちます。

#### 2.5 技術スタックと記述ルール

**重要：ES5互換の記述を厳守**
- `const`, `let` は使用禁止 → 必ず `var` を使用
- アロー関数 `=>` は使用禁止 → 必ず `function(){}` を使用
- テンプレートリテラル `` `...${}...` `` は使用禁止 → 文字列連結 `'...' + ...` を使用
- 分割代入は使用禁止

**シミュレーション（原則として必須）**
- **原則として各小問にはシミュレーションや図を含めること。** 物理現象を視覚的に理解するため、可能な限り動的な可視化を追加してください。
- **ライブラリ**：基本は **p5.js**。問題の状況に応じて **Three.js**（3D・光学系・回転など）、**Matter.js**（接触・衝突・拘束）、**JSXGraph / Chart.js**（グラフ作図）も使用する。
- `id="sim-{unique_id}"` を持つ `class="sim-embed"` の `div` に描画
- `SimUtils.addSlider(containerId, "ラベル", min, max, initial, step, function(val) { ... })` を使用（該当する場合）
- `sim-embed` はCSSで自動的に高さが調整されるため、固定の `style="height: ..."` は避ける
- ライブラリのCDNは含めず、ロジックのみを記述（親ページでロード済み想定）

**数式**
- MathJax（`$...$` または `$$...$$`）を使用

**装飾**
- プロジェクト標準クラス（`.box-alert`, `.card`, `.prob-title-sub`, `.box-note`）を適切に使用
- **答えは必ず `<div class="box-note">` で囲む**（`<strong>答え：</strong>` または `<strong>答</strong>` の直後を box-note 内に記述）。答えだけを `<p>` に書かない。
- 重要な語句や公式には `<span class="highlight">...</span>` を使用（黄色マーカー）
- 特に強い強調には `<strong>...</strong>` を使用

#### 2.6 HTML構造の厳守
- `sample.html` の構造を厳守
- class名やDOM構造を勝手に変更しない
- **見出しタイトル（prob-title-sub）**：`問題番号` と `物理テーマ` のみを書く。**[物理基礎 (物基707) 演習問題3]** のように教材名・問題種別を括弧でくくった表記は**含めない**（以後の自動生成でも同様とする）。
- **問題タイトルは画像の表記をそのまま使用する**：アップロードされた問題画像のヘッダーやタイトル（例：「29 縦波」「演習問題2：弦の振動」）に表記されている問題番号・物理テーマの文言を**そのまま**用いる。要約や言い換えをせず、画像と一致させる。
- 以下の基本構造を維持（2.1 の順序・セクション名と一致させる）：
```html
<h2 class="prob-title-sub">問題番号：物理テーマ</h2>
<div class="card">
  <h3>解法の全体像</h3>
  ...
</div>
<div class="card">
  <h3>(1) 小問タイトル</h3>
  ...
</div>
<!-- 他の小問の card を続ける -->
<div class="box-alert">
  <span class="box-alert-label">Point</span>
  <h3>解法のポイント</h3>
  <ul>...</ul>
</div>
<!-- 答一覧は含めない -->
```

#### 2.7 解説ページ作成・増築時のチェックリスト

解説ページを**新規作成**または**既存ページに追記・修正**するときは、作業完了前に以下を必ず確認する：

- [ ] **冒頭**に `<h3>解法の全体像</h3>` の card がある（「解法の指針」などの別名になっていない）
- [ ] **各設問**が `<div class="card">` で区切られ、問題で聞かれている内容を簡潔に説明している
- [ ] 各設問に**図またはシミュレーション**が少なくとも1つずつある（見やすく精密なもの）
- [ ] 解説は**高校物理の範囲内**で、補足・別解を積極的に入れている
- [ ] **最後**に `<div class="box-alert">` で「解法のポイント」を箇条書きしている
- [ ] **答一覧・解答一覧**のセクションや `answer-table` は含めていない（既存にあった場合は削除）
- [ ] **各設問の答え**がすべて `<div class="box-note">` で囲まれている（答えが `<p>` のみの場合は box-note を付与）
- [ ] ES5互換（`var` / `function` / 文字列連結）、プロジェクト標準クラス、`sim-embed` の使い方を守っている

### 3. ファイル命名とパス規則

#### 3.1 保存パス（explanationPath）の決定ルール

**教科書**
- 物理基礎: `data/explanations/textbook_basic/{編ID}/{章ID}/{ID}.html`
- 物理: `data/explanations/textbook_physics/{編ID}/{章ID}/{ID}.html`

**リード系**
- `data/explanations/{lead_alpha|lead_light}/{章ID}/{ID}.html`

**入試問題**
- `data/explanations/{exam_common|exam_national|exam_private}/{大学IDor年度}/{ID}.html`

#### 3.2 フォルダ自動振分リファレンス

| 科目 | 入力された単元名(キーワード) | 振分先フォルダID |
| :--- | :--- | :--- |
| **物理基礎** | 運動の表し方 / 運動の法則 / 仕事とエネルギー | `01/01` / `01/02` / `01/03` |
| | 熱 / 波 / 音 | `02/01` / `03/01` / `03/02` |
| **物理** | 剛体 / 運動量 / 円運動 / 単振動 / 重力 | `01/01`〜`01/05` |
| | 気体分子 / 熱力学 | `02/01` / `02/02` |
| | 波の伝わり方 / 音 / 光 | `03/01`〜`03/03` |
| | 電場 / 電流 / 磁場 / 電磁誘導 | `04/01`〜`04/04` |
| | 電子と光 / 原子と原子核 | `05/01` / `05/02` |

#### 3.3 登録JSONフォーマット
```json
{
  "id": "一意のID（半角英数）",
  "title": "表示タイトル（問題番号 + 物理テーマ）",
  "desc": "短い説明",
  "explanationPath": "上記ルールに基づいたパス"
}
```

### 4. 自動生成時の出力形式

画像/PDFアップロード時に、以下の2ブロックを独立して出力してください：

#### 【ブロック1】解説HTML
- HTMLコードブロックとして出力
- `sample.html` の構造を厳守
- `<h2>` タイトルには「問題番号」に加え「物理的なテーマ（例: ドップラー効果）」を必ず含める
- 2.1 の標準構成（解法の全体像 → 各設問の解説 → 解法のポイント）と 2.7 のチェックリストに従う。答一覧は出力しない

#### 【ブロック2】登録用JSON
- JSONコードブロックとして出力
- `explanationPath` は教材指定と単元名から自動生成
- `id` は他と重複しないユニークな文字列
- `layout` は指定不要（デフォルト記事形式）

### 5. ファイル保存とマニフェスト登録の自動化（★1回の応答で必ず完了）

解説HTML生成後、**同じ応答内で**以下をすべて実行する。ユーザーに追加指示を求めない：

1. **HTMLファイルの保存**
   - `explanationPath` に基づいて適切なディレクトリに保存
   - ディレクトリが存在しない場合は自動作成
   - ファイル名は `{ID}.html`

2. **マニフェストJSONへの自動登録**（★省略禁止）
   - 該当する `data/materials/{教材ID}.json` を**読み込み**
   - 問題に対応する**正しい編・章**の `fields` エントリを特定し、その `problems` 配列に追加
   - 問題の `id`, `title`, `desc`, `explanationPath` を設定
   - `title` は「演習問題1：弦の振動」のように「問題種別：物理テーマ」形式にする
   - 科目・分野が存在しない場合は自動作成

3. **完了報告**
   - 保存したHTMLファイルパス
   - 登録先のマニフェストJSONパスと編・章名
   - 生成したシミュレーションの概要（何を再現したか）

### 6. ユーザーとの対話フロー

画像/PDFアップロード時、以下の情報をユーザーに確認または推測：

1. **教材タイプ**
   - 物理基礎 (textbook_basic)
   - 物理 (textbook_physics)
   - リードα (lead_alpha)
   - リードLight (lead_light)
   - 共通テスト (exam_common)
   - 国公立入試 (exam_national)
   - 私立入試 (exam_private)
   - その他 (other)

2. **基本情報**
   - 年度または章番号
   - 問題番号またはページ
   - 単元名（分野）または大学名（教科書の場合は必須）
   - ファイル名ID（半角英数）

3. **問題内容の確認**
   - 画像/PDFから問題文、図、数値条件を正確に読み取る
   - 該当する問題が見つからない場合のみ、問題文の入力を求める

### 7. エラーハンドリング

- パスが無効な場合：エラーメッセージを表示し、正しいパス形式を提示
- ID重複の場合：既存の問題を上書きするか確認
- ディレクトリ作成失敗：警告を表示し、手動での確認を促す
- JSONパースエラー：エラーメッセージを表示し、JSON形式を確認

### 8. 既存ファイルの参照

作業前に以下を確認：
- `sample.html`: HTML構造のテンプレート
- `プロンプト.txt`: 詳細な生成ルール
- `チャット.txt`: ユーザー入力フォーマットの参考
- `data/manifest.json`: 教材ID一覧
- `data/materials/*.json`: 既存の問題構造

### 9. ベストプラクティス

1. **シミュレーションは省略不可**: 問題画像から解説を生成する際、**最初の応答で必ず**問題状況を再現するシミュレーションを含める。**基本は p5.js** とし、3Dや複雑な物理が必要な場合は **Three.js・Matter.js** 等を問題の状況に応じて使い分ける。「後から追加」は許容しない。各小問にも可能な限り図・シミュを含める。
2. **段階的な説明**: 初学者にも分かりやすい段階的な解説
3. **別解の提示**: 複数のアプローチを提示して理解を深める
4. **大学物理への橋渡し**: 高校範囲を超えた背景知識を適宜追加
5. **視覚的な強調**: 重要な概念はハイライトや太字で強調

### 10. コミットとデプロイ

生成・更新後は：
1. 変更内容を確認
2. `git add .` で変更をステージング
3. `git commit -m "解説ページ追加: {タイトル}"` でコミット
4. 必要に応じて `git push` で共有
5. 本番公開時は **`npm run deploy`** を実行（内部でキャッシュ名のバージョンを1つ上げてから `firebase deploy` する）。手動でデプロイする場合は `npm run bump-cache` のあと `firebase deploy`。
