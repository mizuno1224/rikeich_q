# 理系チャンネル 問題解説ビューアー - Cursor管理ルール

## プロジェクト概要
このプロジェクトは高校物理のWeb教材開発システムです。Cursorのチャットで画像やPDFをアップロードすると、自動的に解説ページが生成・追加されるワークフローを実装しています。

## 画像・PDFアップロード時の自動処理ルール

### 1. アップロード検知と処理フロー
ユーザーがCursorチャットに画像やPDFをアップロードした場合、以下の手順で自動処理します：

1. **問題の特定**: アップロードされた画像/PDFから問題文、図、数値条件を読み取る
2. **教材情報の確認**: ユーザーに教材タイプ（教科書/リード/入試問題等）を確認
3. **解説HTMLの生成**: プロンプトルールに従って解説ページを生成
4. **登録JSONの生成**: 適切なパスとIDで登録情報を生成
5. **ファイルの自動保存**: 生成されたHTMLとJSONを適切な場所に保存
6. **マニフェストの更新**: 必要に応じてmaterials JSONを更新

### 2. 解説ページ生成の基本ルール

#### 2.1 構成要素（必須）
解説HTMLは以下の流れで構成してください：

1. **解法の指針**
   - 問題を解くための全体像
   - 物理現象の核となる考え方

2. **小問ごとの丁寧なステップ解説**
   **重要：原則として各小問にはシミュレーションや図を含めること。** 視覚的な理解を促進するため、可能な限り動的な可視化や図解を追加することが必須です。
   - 各小問((1), (2)...)ごとに以下を最適な順序で組み込む：
     - 導出プロセス（図解を交えた立式から計算まで）
     - 概念の補足（直感的に分かりにくい部分の説明）
     - リッチなシミュレーション（Matter.js, JSXGraph, Chart.js, p5.js, Three.js）**原則として各小問には少なくとも1つ以上のシミュレーションまたは図を含めること**
     - 別解（微積含む）
     - コラム：大学物理への橋渡し

3. **解法のポイントまとめ（ページ最後に配置）**
   - この問題から得られる普遍的なポイントを箇条書き

#### 2.2 技術スタックと記述ルール

**重要：ES5互換の記述を厳守**
- `const`, `let` は使用禁止 → 必ず `var` を使用
- アロー関数 `=>` は使用禁止 → 必ず `function(){}` を使用
- テンプレートリテラル `` `...${}...` `` は使用禁止 → 文字列連結 `'...' + ...` を使用
- 分割代入は使用禁止

**シミュレーション（原則として必須）**
- **原則として各小問にはシミュレーションや図を含めること。** 物理現象を視覚的に理解するため、可能な限り動的な可視化を追加してください。
- `id="sim-{unique_id}"` を持つ `class="sim-embed"` の `div` に描画
- `SimUtils.addSlider(containerId, "ラベル", min, max, initial, step, function(val) { ... })` を使用
- `sim-embed` はCSSで自動的に高さが調整されるため、固定の `style="height: ..."` は避ける
- ライブラリのCDNは含めず、ロジックのみを記述（親ページでロード済み想定）

**数式**
- MathJax（`$...$` または `$$...$$`）を使用

**装飾**
- プロジェクト標準クラス（`.box-alert`, `.card`, `.prob-title-sub`, `.box-note`）を適切に使用
- 重要な語句や公式には `<span class="highlight">...</span>` を使用（黄色マーカー）
- 特に強い強調には `<strong>...</strong>` を使用

#### 2.3 HTML構造の厳守
- `sample.html` の構造を厳守
- class名やDOM構造を勝手に変更しない
- 以下の基本構造を維持：
```html
<h2 class="prob-title-sub">問題番号：物理テーマ</h2>
<div class="card">
  <h3>解法の指針</h3>
  ...
</div>
<div class="card">
  <h3>(1) 小問タイトル</h3>
  ...
</div>
<div class="box-alert">
  <span class="box-alert-label">Point</span>
  ...
</div>
```

### 3. ファイル命名とパス規則

#### 3.1 保存パス（explanationPath）の決定ルール

**教科書**
- 物理基礎: `data/explanations/textbook_basic/{編ID}/{章ID}/{ID}.html`
- 物理: `data/explanations/textbook_physics/{編ID}/{章ID}/{ID}.html`

**リード系**
- `data/explanations/{lead_alpha|lead_light}/{章ID}/{ID}.html`

**入試問題**
- `data/explanations/{exam_common|exam_national|exam_private}/{大学IDor年度}/{ID}.html`

#### 3.2 フォルダ自動振分リファレンス

| 科目 | 入力された単元名(キーワード) | 振分先フォルダID |
| :--- | :--- | :--- |
| **物理基礎** | 運動の表し方 / 運動の法則 / 仕事とエネルギー | `01/01` / `01/02` / `01/03` |
| | 熱 / 波 / 音 | `02/01` / `03/01` / `03/02` |
| | 電気 / 磁気 | `04/01` / `04/02` |
| | エネルギーの利用 | `05/01` |
| **物理** | 剛体 / 運動量 / 円運動 / 単振動 / 重力 | `01/01`〜`01/05` |
| | 気体分子 / 熱力学 | `02/01` / `02/02` |
| | 波の伝わり方 / 音 / 光 | `03/01`〜`03/03` |
| | 電場 / 電流 / 磁場 / 電磁誘導 | `04/01`〜`04/04` |
| | 電子と光 / 原子と原子核 | `05/01` / `05/02` |

#### 3.3 登録JSONフォーマット
```json
{
  "id": "一意のID（半角英数）",
  "title": "表示タイトル（問題番号 + 物理テーマ）",
  "desc": "短い説明",
  "explanationPath": "上記ルールに基づいたパス"
}
```

### 4. 自動生成時の出力形式

画像/PDFアップロード時に、以下の2ブロックを独立して出力してください：

#### 【ブロック1】解説HTML
- HTMLコードブロックとして出力
- `sample.html` の構造を厳守
- `<h2>` タイトルには「問題番号」に加え「物理的なテーマ（例: ドップラー効果）」を必ず含める

#### 【ブロック2】登録用JSON
- JSONコードブロックとして出力
- `explanationPath` は教材指定と単元名から自動生成
- `id` は他と重複しないユニークな文字列
- `layout` は指定不要（デフォルト記事形式）

### 5. ファイル保存の自動化

生成されたHTMLとJSONは、以下の手順で自動保存します：

1. **HTMLファイルの保存**
   - `explanationPath` に基づいて適切なディレクトリに保存
   - ディレクトリが存在しない場合は自動作成
   - ファイル名は `{ID}.html`

2. **マニフェストの更新**
   - 該当する `data/materials/{教材ID}.json` を読み込み
   - 適切な科目・分野に問題を追加
   - 科目・分野が存在しない場合は自動作成

3. **確認メッセージ**
   - 保存完了後、生成されたファイルパスとタイトルを表示

### 6. ユーザーとの対話フロー

画像/PDFアップロード時、以下の情報をユーザーに確認または推測：

1. **教材タイプ**
   - 物理基礎 (textbook_basic)
   - 物理 (textbook_physics)
   - リードα (lead_alpha)
   - リードLight (lead_light)
   - 共通テスト (exam_common)
   - 国公立入試 (exam_national)
   - 私立入試 (exam_private)
   - その他 (other)

2. **基本情報**
   - 年度または章番号
   - 問題番号またはページ
   - 単元名（分野）または大学名（教科書の場合は必須）
   - ファイル名ID（半角英数）

3. **問題内容の確認**
   - 画像/PDFから問題文、図、数値条件を正確に読み取る
   - 該当する問題が見つからない場合のみ、問題文の入力を求める

### 7. エラーハンドリング

- パスが無効な場合：エラーメッセージを表示し、正しいパス形式を提示
- ID重複の場合：既存の問題を上書きするか確認
- ディレクトリ作成失敗：警告を表示し、手動での確認を促す
- JSONパースエラー：エラーメッセージを表示し、JSON形式を確認

### 8. 既存ファイルの参照

作業前に以下を確認：
- `sample.html`: HTML構造のテンプレート
- `プロンプト.txt`: 詳細な生成ルール
- `チャット.txt`: ユーザー入力フォーマットの参考
- `data/manifest.json`: 教材ID一覧
- `data/materials/*.json`: 既存の問題構造

### 9. ベストプラクティス

1. **シミュレーションの活用（原則として必須）**: 原則として各小問にはシミュレーションや図を含める。可能な限り動的な可視化を追加し、物理現象を視覚的に理解できるようにする。
2. **段階的な説明**: 初学者にも分かりやすい段階的な解説
3. **別解の提示**: 複数のアプローチを提示して理解を深める
4. **大学物理への橋渡し**: 高校範囲を超えた背景知識を適宜追加
5. **視覚的な強調**: 重要な概念はハイライトや太字で強調

### 10. コミットとデプロイ

生成・更新後は：
1. 変更内容を確認
2. `git add .` で変更をステージング
3. `git commit -m "解説ページ追加: {タイトル}"` でコミット
4. 必要に応じて `git push` で共有
5. 本番公開時は `firebase deploy` を実行
