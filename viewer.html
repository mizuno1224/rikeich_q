/* js/viewer.js */

// ãƒã‚¤ãƒ³ã‚¿ãƒ¼
let pointerInstance = null;

document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const probId = params.get('id');
  const srcPath = params.get('src'); // åˆ†å‰²JSONã®ãƒ‘ã‚¹ã‚’å—ã‘å–ã‚‹

  // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
  // srcãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°æ—§æ¥ã® problems.json ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨
  const fetchTarget = srcPath ? srcPath : 'problems.json';

  fetch(fetchTarget)
    .then(res => {
      if (!res.ok) throw new Error("JSON load failed");
      return res.json();
    })
    .then(data => {
      // Split JSONã®å ´åˆã¯ data ãŒç›´æ¥ Material Object ( {subjects: ...} )
      // problems.json (Legacy) ã®å ´åˆã¯ Array ( [{subjects:...}, ...] )
      let problemsList = [];
      
      if (Array.isArray(data)) {
        // Legacy: å…¨é…åˆ—ã‹ã‚‰æ¢ã™
        problemsList = data;
      } else {
        // Split: 1ã¤ã®Materialã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§ã€é…åˆ—ã«å…¥ã‚Œã¦æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…±é€šåŒ–
        problemsList = [data];
      }
      
      loadProblem(probId, problemsList);
    })
    .catch(err => {
      console.error(err);
      document.getElementById('text-target').innerHTML = "<p>å•é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
    });

  // (ãƒã‚¤ãƒ³ã‚¿ãƒ¼UIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— - å¤‰æ›´ãªã—)
  const btnPointer = document.getElementById('btn-toggle-pointer');
  if(document.getElementById('pointer-canvas') && typeof LaserPointer !== 'undefined'){
    pointerInstance = new LaserPointer('pointer-canvas');
    window.addEventListener('scroll', () => pointerInstance.clear(), { passive: true });
    const expl = document.querySelector('.explanation-area');
    if(expl) expl.addEventListener('scroll', () => pointerInstance.clear(), { passive: true });
  }
  if(btnPointer) {
    btnPointer.addEventListener('click', () => {
      const isActive = document.body.classList.toggle('pointer-active');
      btnPointer.classList.toggle('active', isActive);
      btnPointer.innerHTML = isActive ? 'ğŸ–Šï¸ ãƒã‚¤ãƒ³ã‚¿ãƒ¼ON' : 'ğŸ‘† æ“ä½œãƒ¢ãƒ¼ãƒ‰';
      if(pointerInstance) pointerInstance.clear();
    });
  }
});

function loadProblem(id, dataset) {
  // å‰ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰Šé™¤
  if (window.p5Instances) {
    window.p5Instances.forEach(p => p.remove());
    window.p5Instances = [];
  }

  let target = null;
  // æ¢ç´¢
  for (const mat of dataset) {
    for (const sub of mat.subjects) {
      for (const fld of sub.fields) {
        const found = fld.problems.find(p => p.id === id);
        if (found) { target = found; break; }
      }
      if (target) break;
    }
    if (target) break;
  }

  if (target) {
    document.title = target.title;
    const titleEl = document.getElementById('prob-title-header');
    if(titleEl) titleEl.textContent = target.title;

    if (target.layout === 'article') {
      document.body.classList.add('layout-article');
    } else {
      document.body.classList.remove('layout-article');
    }

    const textTarget = document.getElementById('text-target');
    if (textTarget) {
      if (target.explanationPath) {
        fetch(target.explanationPath)
          .then(res => {
            if(!res.ok) throw new Error("Explanation file not found");
            return res.text();
          })
          .then(html => {
            textTarget.innerHTML = html;
            if(window.MathJax) MathJax.typesetPromise([textTarget]);
            executeInlineScripts(textTarget);
            if(window.updateObserver) setTimeout(window.updateObserver, 100);
          })
          .catch(err => {
            console.warn(err);
            textTarget.innerHTML = "<p>è§£èª¬ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
          });
      } else {
        textTarget.innerHTML = "<p>è§£èª¬ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
      }
    }
    // JS Path Logic (Legacy)
    if (target.jsPath) {
       // å¿…è¦ã«å¿œã˜ã¦æ—§JSãƒ­ã‚¸ãƒƒã‚¯
    }
  } else {
    document.getElementById('text-target').innerHTML = `<p>å•é¡ŒID "${id}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>`;
  }
}

function executeInlineScripts(element) {
  const scripts = element.querySelectorAll('script');
  scripts.forEach(oldScript => {
    const newScript = document.createElement('script');
    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
    newScript.textContent = oldScript.textContent;
    oldScript.parentNode.replaceChild(newScript, oldScript);
  });
}