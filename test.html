<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§£èª¬ã‚³ãƒ¼ãƒ‰ å³æ™‚ãƒ†ã‚¹ãƒˆç’°å¢ƒ</title>
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/viewer.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  
  <style>
    /* ãƒ†ã‚¹ãƒˆç’°å¢ƒå°‚ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    .test-toolbar {
      flex-shrink: 0;
      background: #1e293b;
      padding: 10px 20px;
      display: flex;
      gap: 10px;
      align-items: center;
      color: #fff;
      border-bottom: 1px solid #334155;
      z-index: 1000;
    }
    .test-toolbar h1 { margin: 0; font-size: 1rem; margin-right: 20px; color: #94a3b8; }
    
    .btn-run { background: #10b981; color: white; border: none; padding: 5px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
    .btn-run:hover { background: #059669; }
    .btn-clear { background: #64748b; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; }
    
    .split-view {
      flex: 1;
      display: flex;
      height: calc(100vh - 50px);
    }
    
    /* å·¦å´ï¼šã‚³ãƒ¼ãƒ‰å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .editor-pane {
      width: 40%;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #cbd5e1;
      background: #f8fafc;
    }
    
    #code-input {
      flex: 1;
      width: 100%;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      border: none;
      resize: none;
      background: #1e1e1e;
      color: #d4d4d4;
      outline: none;
    }
    
    /* å³å´ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
    .preview-pane {
      width: 60%;
      position: relative;
      background: #fff;
    }
    
    .viewer-container { height: 100%; }
    .viewer-split-content { height: 100%; padding: 10px; }
    .simulation-area, .explanation-area { height: 100%; overflow: hidden; }
    .explanation-area { overflow-y: auto; }

    /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
    #error-log {
      color: #f43f5e;
      font-size: 0.85rem;
      margin-left: auto;
      background: rgba(0,0,0,0.2);
      padding: 2px 8px;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>
<body>

  <div class="test-toolbar">
    <h1>ğŸ› ï¸ Test Runner</h1>
    <button class="btn-run" onclick="runTest()">â–¶ å®Ÿè¡Œ (Ctrl+Enter)</button>
    <button class="btn-clear" onclick="clearEditor()">ã‚¯ãƒªã‚¢</button>
    <span id="error-log"></span>
  </div>

  <div class="split-view">
    <div class="editor-pane">
      <textarea id="code-input" placeholder="// ã“ã“ã«AIãŒç”Ÿæˆã—ãŸJSã‚³ãƒ¼ãƒ‰ï¼ˆwindow.setup_... ã¾ãŸã¯ PhysicsLab.problems[...] = ...ï¼‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
    </div>
    
    <div class="preview-pane">
      <div class="viewer-container">
        <div class="viewer-split-content">
          <div id="sim-target" class="simulation-area"></div>
          <div id="text-target" class="explanation-area">
            <div class="placeholder-text" style="margin-top: 50px;">
              ã“ã“ã«è§£èª¬ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>å·¦ã«ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã£ã¦ã€Œå®Ÿè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/sim-utils.js"></script>

  <script>
    const codeInput = document.getElementById('code-input');
    const simTarget = document.getElementById('sim-target');
    const textTarget = document.getElementById('text-target');
    const errorLog = document.getElementById('error-log');

    // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼
    codeInput.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        runTest();
      }
    });

    function clearEditor() {
      if(confirm('ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) codeInput.value = '';
    }

    function runTest() {
      // 1. ãƒªã‚»ãƒƒãƒˆ
      resetEnvironment();

      // 2. ã‚³ãƒ¼ãƒ‰å–å¾—
      const rawCode = codeInput.value;
      if (!rawCode.trim()) return;

      try {
        // 3. ã‚³ãƒ¼ãƒ‰ã®è©•ä¾¡
        const runScript = new Function(rawCode);
        runScript();

        // 4. é–¢æ•°å®Ÿè¡Œ (æ–°æ—§å¯¾å¿œ)
        let targetFunc = null;
        let funcNameStr = "";

        // æ–°: PhysicsLab.problems ã«è¿½åŠ ã•ã‚ŒãŸæœ€å¾Œã®ã‚­ãƒ¼ã‚’æ¢ã™
        // (ã‚­ãƒ¼é †åºã¯ä¿è¨¼ã•ã‚Œãªã„ãŒã€é€šå¸¸è¿½åŠ é †)
        if (window.PhysicsLab && window.PhysicsLab.problems) {
           const keys = Object.keys(window.PhysicsLab.problems);
           if(keys.length > 0) {
             funcNameStr = keys[keys.length - 1];
             targetFunc = window.PhysicsLab.problems[funcNameStr];
           }
        }

        // æ—§: setup_... ã‚’æ¢ã™
        if (!targetFunc) {
           const keys = Object.keys(window).filter(k => k.startsWith('setup_'));
           if (keys.length > 0) {
             funcNameStr = keys[keys.length - 1];
             targetFunc = window[funcNameStr];
           }
        }

        if (!targetFunc) {
          throw new Error("å®Ÿè¡Œå¯èƒ½ãªé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (PhysicsLab.problems ã¾ãŸã¯ window.setup_...)");
        }

        console.log(`Executing: ${funcNameStr}`);
        targetFunc('sim-target', 'text-target');

        // MathJaxé©ç”¨
        if(window.MathJax) {
          MathJax.typesetPromise ? MathJax.typesetPromise([textTarget]) : MathJax.Hub.Queue(["Typeset", MathJax.Hub, textTarget]);
        }
        
        showError(null); 

      } catch (e) {
        console.error(e);
        showError(e.message);
      }
    }

    function resetEnvironment() {
      if (window.p5Instances) {
        window.p5Instances.forEach(p => p.remove());
        window.p5Instances = [];
      }
      simTarget.innerHTML = '';
      textTarget.innerHTML = '';
    }

    function showError(msg) {
      if(msg) {
        errorLog.textContent = "âš ï¸ " + msg;
        errorLog.style.display = 'inline-block';
      } else {
        errorLog.style.display = 'none';
      }
    }
  </script>
</body>
</html>